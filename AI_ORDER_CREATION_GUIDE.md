# ğŸ›’ HÆ°á»›ng dáº«n: Táº¡o ÄÆ¡n HÃ ng báº±ng AI

## ğŸ¯ Tá»•ng quan

TÃ­nh nÄƒng AI Order Creation cho phÃ©p ngÆ°á»i dÃ¹ng mua vÃ© sá»± kiá»‡n thÃ´ng qua chat vá»›i AI, vá»›i quy trÃ¬nh hoÃ n chá»‰nh:

```
1. Chá»n sá»± kiá»‡n
2. Chá»n loáº¡i vÃ©
3. Äiá»n thÃ´ng tin
4. XÃ¡c nháº­n vÃ  thanh toÃ¡n
```

---

## ğŸ—£ï¸ CÃC CÃ‚U Lá»†NH AI

### 1. **Báº¯t Ä‘áº§u mua vÃ©:**
```
"TÃ´i muá»‘n mua vÃ© sá»± kiá»‡n Music Festival"
"Mua vÃ© Workshop AI"
"ÄÄƒng kÃ½ tham gia event Competition 2024"
```

### 2. **Chá»n loáº¡i vÃ©:**
```
"Chá»n vÃ© VIP"
"TÃ´i muá»‘n vÃ© Standard"
"Láº¥y vÃ© Early Bird"
```

### 3. **Cung cáº¥p thÃ´ng tin:**
```
"TÃªn: Nguyá»…n VÄƒn A, Email: test@gmail.com, SÄT: 0123456789"
"Há» tÃªn: Tráº§n Thá»‹ B, Email: example@email.com"
```

### 4. **XÃ¡c nháº­n:**
```
"CÃ³"
"XÃ¡c nháº­n"
"OK"
"Äá»“ng Ã½"
```

### 5. **Há»§y Ä‘Æ¡n:**
```
"Há»§y Ä‘Æ¡n hÃ ng"
"KhÃ´ng mua ná»¯a"
"Cancel"
```

---

## ğŸ“‹ QUY TRÃŒNH CHI TIáº¾T

### **BÆ¯á»šC 1: CHá»ŒN Sá»° KIá»†N**

**User input:**
```
"TÃ´i muá»‘n mua vÃ© sá»± kiá»‡n Music Festival"
```

**AI response:**
```
ğŸ« Sá»± kiá»‡n: **Music Festival 2024**

ğŸ“… Thá»i gian: 2024-12-20 18:00

CÃ¡c loáº¡i vÃ© cÃ³ sáºµn:

â€¢ **VIP**
  - GiÃ¡: 500,000 VND
  - CÃ²n láº¡i: 50 vÃ©
  - MÃ´ táº£: Gháº¿ ngá»“i háº¡ng sang, free drinks

â€¢ **Standard**
  - GiÃ¡: 200,000 VND
  - CÃ²n láº¡i: 200 vÃ©
  - MÃ´ táº£: VÃ© thÆ°á»ng

â€¢ **Early Bird**
  - GiÃ¡: 150,000 VND
  - CÃ²n láº¡i: 0 vÃ©
  - MÃ´ táº£: VÃ© Æ°u Ä‘Ã£i sá»›m

ğŸ’¡ Báº¡n muá»‘n chá»n loáº¡i vÃ© nÃ o?
```

---

### **BÆ¯á»šC 2: CHá»ŒN LOáº I VÃ‰**

**User input:**
```
"Chá»n vÃ© VIP"
```

**AI response:**
```
âœ… ÄÃ£ chá»n vÃ© **VIP** - GiÃ¡: 500,000 VND

ğŸ“ Vui lÃ²ng cung cáº¥p thÃ´ng tin:
- TÃªn ngÆ°á»i tham gia
- Email
- Sá»‘ Ä‘iá»‡n thoáº¡i (tÃ¹y chá»n)

VÃ­ dá»¥: 'TÃªn: Nguyá»…n VÄƒn A, Email: test@gmail.com, SÄT: 0123456789'
```

---

### **BÆ¯á»šC 3: ÄIá»€N THÃ”NG TIN**

**User input:**
```
"TÃªn: Nguyá»…n VÄƒn A, Email: nguyenvana@gmail.com, SÄT: 0912345678"
```

**AI response:**
```
ğŸ“‹ **XÃ¡c nháº­n thÃ´ng tin Ä‘Æ¡n hÃ ng:**

ğŸ« Sá»± kiá»‡n: Music Festival 2024
ğŸŸï¸ Loáº¡i vÃ©: VIP
ğŸ’° GiÃ¡: 500,000 VND

ğŸ‘¤ ThÃ´ng tin ngÆ°á»i tham gia:
- TÃªn: Nguyá»…n VÄƒn A
- Email: nguyenvana@gmail.com
- SÄT: 0912345678

ğŸ’¡ XÃ¡c nháº­n Ä‘áº·t vÃ©? (CÃ³/KhÃ´ng)
```

---

### **BÆ¯á»šC 4: XÃC NHáº¬N VÃ€ Táº O ÄÆ N**

**User input:**
```
"CÃ³"
```

**AI response:**
```
âœ… ÄÃ£ táº¡o Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng!
ğŸ”— Link thanh toÃ¡n: https://payos.vn/payment/xxxxx

ğŸ’¡ Vui lÃ²ng thanh toÃ¡n Ä‘á»ƒ hoÃ n táº¥t Ä‘Äƒng kÃ½.
```

---

## ğŸ”§ KIáº¾N TRÃšC TECHNICAL

### **1. Components:**

#### a. **PendingOrder (DTO)**
```java
@Data
public class PendingOrder {
    private Event event;
    private TicketType ticketType;
    private String participantName;
    private String participantEmail;
    private String participantPhone;
    private OrderStep currentStep;
    
    public enum OrderStep {
        SELECT_EVENT,
        SELECT_TICKET_TYPE,
        PROVIDE_INFO,
        CONFIRM_ORDER
    }
}
```

#### b. **OrderAIService**
```java
@Service
public class OrderAIService {
    // Store pending orders
    Map<Long, PendingOrder> pendingOrders;
    
    // Core methods
    String startOrderCreation(Long userId, String eventQuery);
    String selectTicketType(Long userId, String ticketTypeName);
    String provideInfo(Long userId, Map<String, String> info);
    Map<String, Object> confirmOrder(Long userId);
    String cancelOrder(Long userId);
}
```

#### c. **EventAIAgent Integration**
```java
// AI Agent detects ORDER_CREATE intent
switch (intent) {
    case ORDER_CREATE -> {
        // Use OrderAIService
        String response = orderAIService.startOrderCreation(userId, userInput);
        systemResult.append(response);
    }
}
```

---

## ğŸ­ STATE MANAGEMENT

### **Pending Order States:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT_EVENT â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ User: "Mua vÃ© event X"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SELECT_TICKET_TYPEâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ User: "Chá»n vÃ© VIP"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROVIDE_INFO â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ User: "TÃªn: A, Email: a@b.c"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚CONFIRM_ORDER â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ User: "CÃ³"
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ PAYMENT â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ DATA FLOW

### **1. Start Order:**
```
User â†’ AI â†’ OrderAIService.startOrderCreation()
         â†’ EventService.findByTitle()
         â†’ TicketTypeService.getTicketTypesByEvent()
         â†’ Create PendingOrder
         â†’ Return ticket list
```

### **2. Select Ticket:**
```
User â†’ AI â†’ OrderAIService.selectTicketType()
         â†’ Find TicketType from PendingOrder.event
         â†’ Check availability
         â†’ Update PendingOrder.ticketType
         â†’ Ask for participant info
```

### **3. Provide Info:**
```
User â†’ AI â†’ OrderAIService.provideInfo()
         â†’ Parse user input (name, email, phone)
         â†’ Update PendingOrder fields
         â†’ Validate completeness
         â†’ Show confirmation summary
```

### **4. Confirm:**
```
User â†’ AI â†’ OrderAIService.confirmOrder()
         â†’ Get Customer from userId
         â†’ Create CreateOrderWithTicketTypeRequest
         â†’ OrderService.createOrderWithTicketTypes()
         â†’ PaymentService.createPaymentLinkForOrder()
         â†’ Clear PendingOrder
         â†’ Return payment URL
```

---

## ğŸ§  AI INTEGRATION

### **Update System Prompt:**

Add to `EventAIAgent.initializeSystemMessage()`:

```java
systemPrompt.append("""
## Xá»¬ LÃ MUA VÃ‰:
1. Khi ngÆ°á»i dÃ¹ng muá»‘n mua vÃ©:
   - PhÃ¢n tÃ­ch tÃªn sá»± kiá»‡n
   - Hiá»ƒn thá»‹ danh sÃ¡ch vÃ©
   - HÆ°á»›ng dáº«n chá»n vÃ©

2. Khi chá»n vÃ©:
   - XÃ¡c nháº­n loáº¡i vÃ©
   - YÃªu cáº§u thÃ´ng tin ngÆ°á»i tham gia

3. Khi cung cáº¥p thÃ´ng tin:
   - TrÃ­ch xuáº¥t: tÃªn, email, SÄT
   - Hiá»ƒn thá»‹ summary
   - YÃªu cáº§u xÃ¡c nháº­n

4. Khi xÃ¡c nháº­n:
   - Táº¡o Ä‘Æ¡n hÃ ng
   - Táº¡o payment link
   - Tráº£ vá» link thanh toÃ¡n
""");
```

### **Add Intent Detection:**

```java
// In EventAIAgent.processUserInput()
if (userInput.contains("mua vÃ©") || 
    userInput.contains("Ä‘Äƒng kÃ½") ||
    userInput.contains("tham gia")) {
    
    // Start order process
    String response = orderAIService.startOrderCreation(userId, extractEventName(userInput));
    return response;
}
```

---

## âš ï¸ ERROR HANDLING

### **1. Event not found:**
```
âŒ KhÃ´ng tÃ¬m tháº¥y sá»± kiá»‡n "XYZ". Vui lÃ²ng kiá»ƒm tra láº¡i tÃªn sá»± kiá»‡n.
```

### **2. Ticket sold out:**
```
âŒ Loáº¡i vÃ© "VIP" Ä‘Ã£ háº¿t. Vui lÃ²ng chá»n loáº¡i vÃ© khÃ¡c.
```

### **3. Missing information:**
```
âš ï¸ CÃ²n thiáº¿u thÃ´ng tin:
- TÃªn ngÆ°á»i tham gia
- Email

Vui lÃ²ng cung cáº¥p Ä‘áº§y Ä‘á»§ thÃ´ng tin.
```

### **4. Order creation failed:**
```
âŒ Lá»—i khi táº¡o Ä‘Æ¡n hÃ ng: [error message]
Vui lÃ²ng thá»­ láº¡i sau.
```

---

## ğŸ§ª TESTING

### **Test Flow:**

```bash
# 1. Start order
curl -X POST http://localhost:8080/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Mua vÃ© Music Festival",
    "userId": 1
  }'

# 2. Select ticket
curl -X POST http://localhost:8080/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Chá»n vÃ© VIP",
    "userId": 1
  }'

# 3. Provide info
curl -X POST http://localhost:8080/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "TÃªn: Test User, Email: test@test.com",
    "userId": 1
  }'

# 4. Confirm
curl -X POST http://localhost:8080/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "CÃ³",
    "userId": 1
  }'
```

---

## ğŸ”’ SECURITY

### **1. User Authentication:**
```java
// Verify user owns the order
if (!order.getCustomer().getAccount().getAccountId().equals(userId)) {
    throw new SecurityException("Unauthorized");
}
```

### **2. Ticket Availability:**
```java
// Check ticket still available before creating order
if (!ticketType.isAvailable()) {
    throw new IllegalStateException("Ticket sold out");
}
```

### **3. Session Timeout:**
```java
// Pending orders expire after 30 minutes
if (pendingOrder.getCreatedAt().isBefore(LocalDateTime.now().minusMinutes(30))) {
    pendingOrders.remove(userId);
}
```

---

## ğŸ“Š DATABASE

### **Tables Involved:**

```sql
-- Existing tables used
event (id, title, starts_at, ...)
ticket_type (ticket_type_id, event_id, name, price, ...)
orders (order_id, customer_id, event_id, ticket_type_id, ...)
payments (payment_id, order_id, checkout_url, ...)
```

**No new tables needed!** Uses existing schema.

---

## âœ… CHECKLIST

### Implementation:
- [x] Create PendingOrder DTO
- [x] Create OrderAIService
- [ ] Integrate with EventAIAgent
- [ ] Update AI system prompt
- [ ] Add intent detection
- [ ] Test full flow

### Features:
- [x] Select event
- [x] Select ticket type
- [x] Provide participant info
- [x] Confirm and create order
- [x] Generate payment link
- [x] Cancel order

### Error Handling:
- [x] Event not found
- [x] Ticket not available
- [x] Missing information
- [x] Order creation failed

---

## ğŸš€ NEXT STEPS

### Phase 1: Basic Implementation âœ…
- PendingOrder DTO
- OrderAIService core methods

### Phase 2: AI Integration ğŸ”„
- Update EventAIAgent
- Add to system prompt
- Intent detection

### Phase 3: Enhanced Features ğŸ”®
- Multiple ticket quantities
- Apply vouchers via AI
- Order history lookup
- Order cancellation

---

**Status:** âœ… Core Services Ready - Need AI Integration
**Last Updated:** 2024-10-11
**Version:** 1.0.0



































