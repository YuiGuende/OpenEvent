<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="UTF-8">
	<title>Đăng nhập - OpenEvent</title>
</head>
<body>
	<h1>Đăng nhập</h1>
	<div id="notice" style="white-space: pre-wrap;"></div>
	<form id="loginForm">
		<label>Email: <input type="email" id="loginEmail" required></label><br>
		<label>Mật khẩu: <input type="password" id="loginPassword" required></label>
		<label><input type="checkbox" id="loginShowPw"> Hiện mật khẩu</label><br>
		<button type="submit" id="loginBtn">Đăng nhập</button>
	</form>
	<pre id="loginResult"></pre>
	<p><a href="/security/register.html">Chưa có tài khoản? Đăng ký</a></p>
	<p><a href="/static">Trang chủ</a></p>

	<script>
		function getQueryParam(name) {
			const url = new URL(window.location.href);
			return url.searchParams.get(name);
		}
		(function showNotice() {
			if (getQueryParam('registered') === '1') {
				document.getElementById('notice').textContent = 'Đăng ký thành công! Vui lòng đăng nhập.';
			}
		})();

		document.getElementById('loginShowPw').addEventListener('change', (e) => {
			document.getElementById('loginPassword').type = e.target.checked ? 'text' : 'password';
		});

		async function handleLogin(e) {
			e.preventDefault();
			document.getElementById('loginBtn').disabled = true;
			const payload = {
				email: document.getElementById('loginEmail').value,
				password: document.getElementById('loginPassword').value
			};
			try {
				const res = await fetch('/api/auth/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify(payload)
				});
				const text = await res.text();
				if (!res.ok) {
					document.getElementById('loginResult').textContent = 'Lỗi đăng nhập (' + res.status + '):\n' + text;
				} else {
					try {
						const json = JSON.parse(text);
						if (json.redirectPath) {
							window.location.href = json.redirectPath;
							return;
						}
					} catch (_) {}
					document.getElementById('loginResult').textContent = text;
				}
			} catch (err) {
				document.getElementById('loginResult').textContent = 'Lỗi: ' + err;
			} finally {
				document.getElementById('loginBtn').disabled = false;
			}
		}

		document.getElementById('loginForm').addEventListener('submit', handleLogin);
	</script>
</body>
</html> 