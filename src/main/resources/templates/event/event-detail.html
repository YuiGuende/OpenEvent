<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - OpenEvent</title>
</head>
<body>
    <h1 id="eventTitle">Event Title</h1>
    
    <div id="eventInfo">
        <p><strong>Date:</strong> <span id="eventDate">Event Date</span></p>
        <p><strong>Location:</strong> <span id="eventLocation">Event Location</span></p>
        <p><strong>Type:</strong> <span id="eventType">Event Type</span></p>
        <p><strong>Description:</strong> <span id="eventDescription">Event Description</span></p>
    </div>
    
    <button id="joinEventBtn" onclick="joinEvent()">Join Event</button>
    
    <!-- Customer Check-in Section -->
    <div id="checkinSection" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
        <h3 style="margin-bottom: 15px; color: #28a745;">Check-in cho s·ª± ki·ªán</h3>
        <div id="checkinStatus" style="margin-bottom: 15px;">
            <span id="checkinBadge" style="display: none; padding: 6px 12px; border-radius: 4px; background: #28a745; color: white; font-weight: bold;">
                ‚úì ƒê√£ check-in
            </span>
        </div>
        <div id="checkinButtons" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a id="manualCheckinBtn" href="#" 
               style="flex: 1; min-width: 150px; padding: 12px 20px; background: #28a745; color: white; text-align: center; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;">
                üìù Check-in th·ªß c√¥ng
            </a>
            <a id="faceCheckinBtn" href="#" 
               style="flex: 1; min-width: 150px; padding: 12px 20px; background: #007bff; color: white; text-align: center; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;">
                üì∑ Check-in b·∫±ng khu√¥n m·∫∑t
            </a>
        </div>
    </div>
    
    <!-- Feedback Form Buttons -->
    <div class="mt-3">
        <!-- Host: Create Feedback Form Button -->
        <a th:href="@{'/forms/create/' + ${eventId} + '?type=FEEDBACK'}" 
           class="btn btn-warning mr-2" 
           style="background-color: #ff6b35; border-color: #ff6b35; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-right: 10px;">
            üìù Create Feedback Form
        </a>
        <!-- Host: Create Register Form Button -->
        <a th:href="@{'/forms/create/' + ${eventId} + '?type=REGISTER'}" 
           class="btn btn-outline-primary mr-2" 
           style="border-color: #0d6efd; color: #0d6efd; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-right: 10px;">
            üìù Create Register Form
        </a>
        <!-- Host: Create Check-in Form Button -->
        <a th:href="@{'/forms/create/' + ${eventId} + '?type=CHECKIN'}" 
           class="btn btn-outline-secondary mr-2" 
           style="border-color: #6c757d; color: #6c757d; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-right: 10px;">
            üìù Create Check-in Form
        </a>
        
        <!-- User: Submit Form Button -->
        <a th:href="@{'/forms/' + ${eventId}}" 
           class="btn btn-info mr-2" 
           style="background-color: #17a2b8; border-color: #17a2b8; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-right: 10px;">
            üìù Submit Form
        </a>
        
        <!-- Host: View Responses Button -->
        <a th:href="@{'/forms/responses/' + ${eventId}}" 
           class="btn btn-success" 
           style="background-color: #28a745; border-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">
            üìä View Responses
        </a>
        
        <!-- Host: Show Attendance QR Page (displays both QR codes for scanning) -->
        <a th:href="@{'/events/' + ${eventId} + '/attendance'}"
           class="btn btn-primary"
           style="background-color: #007bff; border-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-left: 10px;">
            üì± Show Check-in/Check-out QR
        </a>
    </div>
    
    <p><a href="/">Back to Home</a></p>

    <script>
        let currentUser = null;
        let eventId = null;

        // Get event ID from URL
        function getEventIdFromUrl() {
            const path = window.location.pathname;
            const parts = path.split('/');
            return parts[parts.length - 1];
        }

        // Load event details from API
        function loadEventDetails() {
            eventId = getEventIdFromUrl();
            
            fetch('/api/event/' + eventId)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Event not found');
                    }
                    return response.json();
                })
                .then(event => {
                    // Display event information
                    document.getElementById('eventTitle').textContent = event.title;
                    
                    // Format date
                    const startDate = new Date(event.startsAt);
                    const endDate = new Date(event.endsAt);
                    const dateStr = startDate.toLocaleDateString('vi-VN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const timeStr = startDate.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) + ' - ' + endDate.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    document.getElementById('eventDate').textContent = dateStr + ' (' + timeStr + ')';
                    
                    // Get location from event places (mock for now)
                    document.getElementById('eventLocation').textContent = getEventLocation(event.type);
                    
                    document.getElementById('eventType').textContent = getEventTypeDisplay(event.type);
                    document.getElementById('eventDescription').textContent = event.description;
                    
                    // Add additional info based on event type
                    addEventSpecificInfo(event);
                })
                .catch(error => {
                    console.error('Error loading event details:', error);
                    document.getElementById('eventTitle').textContent = 'Event Not Found';
                    document.getElementById('eventDescription').textContent = 'The requested event could not be found.';
                });
        }

        // Helper function to get event location (mock implementation)
        function getEventLocation(eventType) {
            const locations = {
                'MusicEvent': 'Outdoor Stage, HCMC',
                'WorkshopEvent': 'Workshop Room 1, Hanoi',
                'COMPETITION': 'Main Auditorium, Da Nang',
                'ConferenceEvent': 'Conference Hall, HCMC'
            };
            return locations[eventType] || 'TBA';
        }

        // Helper function to get display name for event type
        function getEventTypeDisplay(eventType) {
            const types = {
                'MusicEvent': 'Music Festival',
                'WorkshopEvent': 'Workshop',
                'COMPETITION': 'Competition',
                'FestivalEvent': 'Festival',
                'ConferenceEvent': 'Conference'
            };
            return types[eventType] || eventType;
        }

        // Add event-specific information
        function addEventSpecificInfo(event) {
            const eventInfo = document.getElementById('eventInfo');
            
            // Add points if available
            if (event.points) {
                const pointsElement = document.createElement('p');
                pointsElement.innerHTML = '<strong>Points:</strong> <span>' + event.points + '</span>';
                eventInfo.appendChild(pointsElement);
            }
            
            // Add event-specific details
            if (event.type === 'MusicEvent' && event.genre) {
                const genreElement = document.createElement('p');
                genreElement.innerHTML = '<strong>Genre:</strong> <span>' + event.genre + '</span>';
                eventInfo.appendChild(genreElement);
            }
            
            if (event.type === 'WorkshopEvent' && event.skillLevel) {
                const skillElement = document.createElement('p');
                skillElement.innerHTML = '<strong>Skill Level:</strong> <span>' + event.skillLevel + '</span>';
                eventInfo.appendChild(skillElement);
            }
            
            if (event.type === 'COMPETITION' && event.prizePool) {
                const prizeElement = document.createElement('p');
                prizeElement.innerHTML = '<strong>Prize Pool:</strong> <span>' + event.prizePool + '</span>';
                eventInfo.appendChild(prizeElement);
            }
            
            if (event.type === 'ConferenceEvent' && event.conferenceType) {
                const conferenceElement = document.createElement('p');
                conferenceElement.innerHTML = '<strong>Conference Type:</strong> <span>' + event.conferenceType + '</span>';
                eventInfo.appendChild(conferenceElement);
            }
            
            if (event.type === 'ConferenceEvent' && event.maxAttendees) {
                const attendeesElement = document.createElement('p');
                attendeesElement.innerHTML = '<strong>Max Attendees:</strong> <span>' + event.maxAttendees + '</span>';
                eventInfo.appendChild(attendeesElement);
            }
        }

        // Check if customer is authenticated
        function checkAuthentication() {
            fetch('/api/current-user')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        currentUser = data;
                        document.getElementById('joinEventBtn').textContent = 'Join Event';
                        // Check check-in status if user is authenticated
                        checkCheckinStatus();
                    } else {
                        document.getElementById('joinEventBtn').textContent = 'Login to Join';
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    document.getElementById('joinEventBtn').textContent = 'Login to Join';
                });
        }
        
        // Check check-in status for current event
        function checkCheckinStatus() {
            if (!eventId) return;
            
            fetch('/api/events/' + eventId + '/checkin-status', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                const checkinSection = document.getElementById('checkinSection');
                const checkinBadge = document.getElementById('checkinBadge');
                const checkinButtons = document.getElementById('checkinButtons');
                const manualBtn = document.getElementById('manualCheckinBtn');
                const faceBtn = document.getElementById('faceCheckinBtn');
                
                // Show check-in section if user is authenticated
                if (checkinSection) {
                    checkinSection.style.display = 'block';
                }
                
                // Set button URLs
                if (manualBtn) {
                    manualBtn.href = '/events/' + eventId + '/checkin-form';
                }
                if (faceBtn) {
                    faceBtn.href = '/events/' + eventId + '/face-checkin';
                }
                
                if (data.checkedIn) {
                    // Show checked-in badge
                    if (checkinBadge) {
                        checkinBadge.style.display = 'inline-block';
                        checkinBadge.textContent = '‚úì ƒê√£ check-in';
                        if (data.checkInTime) {
                            checkinBadge.textContent += ' (' + new Date(data.checkInTime).toLocaleString('vi-VN') + ')';
                        }
                    }
                    // Disable check-in buttons
                    if (checkinButtons) {
                        checkinButtons.style.opacity = '0.5';
                        checkinButtons.querySelectorAll('a').forEach(btn => {
                            btn.style.pointerEvents = 'none';
                            btn.style.cursor = 'not-allowed';
                        });
                    }
                } else {
                    // Hide badge, enable buttons
                    if (checkinBadge) {
                        checkinBadge.style.display = 'none';
                    }
                    if (checkinButtons) {
                        checkinButtons.style.opacity = '1';
                        checkinButtons.querySelectorAll('a').forEach(btn => {
                            btn.style.pointerEvents = 'auto';
                            btn.style.cursor = 'pointer';
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error checking check-in status:', error);
            });
        }

        // Handle join event button click
        function joinEvent() {
            if (currentUser) {
                // User is logged in, redirect to registration form
                window.location.href = '/event/' + eventId + '/register';
            } else {
                // User not logged in, redirect to login with current URL
                const currentUrl = window.location.pathname;
                window.location.href = '/login?redirect=' + encodeURIComponent(currentUrl);
            }
        }

        // Load page data
        window.onload = function() {
            loadEventDetails();
            checkAuthentication();
        };
    </script>
</body>
</html>
