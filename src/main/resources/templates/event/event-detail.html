<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - OpenEvent</title>
</head>
<body>
    <h1 id="eventTitle">Event Title</h1>
    
    <div id="eventInfo">
        <p><strong>Date:</strong> <span id="eventDate">Event Date</span></p>
        <p><strong>Location:</strong> <span id="eventLocation">Event Location</span></p>
        <p><strong>Type:</strong> <span id="eventType">Event Type</span></p>
        <p><strong>Description:</strong> <span id="eventDescription">Event Description</span></p>
    </div>
    
    <button id="joinEventBtn" onclick="joinEvent()">Join Event</button>
    
    <p><a href="/">Back to Home</a></p>

    <script>
        let currentUser = null;
        let eventId = null;

        // Get event ID from URL
        function getEventIdFromUrl() {
            const path = window.location.pathname;
            const parts = path.split('/');
            return parts[parts.length - 1];
        }

        // Load event details from API
        function loadEventDetails() {
            eventId = getEventIdFromUrl();
            
            fetch('/api/event/' + eventId)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Event not found');
                    }
                    return response.json();
                })
                .then(event => {
                    // Display event information
                    document.getElementById('eventTitle').textContent = event.title;
                    
                    // Format date
                    const startDate = new Date(event.startsAt);
                    const endDate = new Date(event.endsAt);
                    const dateStr = startDate.toLocaleDateString('vi-VN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const timeStr = startDate.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) + ' - ' + endDate.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    document.getElementById('eventDate').textContent = dateStr + ' (' + timeStr + ')';
                    
                    // Get location from event places (mock for now)
                    document.getElementById('eventLocation').textContent = getEventLocation(event.type);
                    
                    document.getElementById('eventType').textContent = getEventTypeDisplay(event.type);
                    document.getElementById('eventDescription').textContent = event.description;
                    
                    // Add additional info based on event type
                    addEventSpecificInfo(event);
                })
                .catch(error => {
                    console.error('Error loading event details:', error);
                    document.getElementById('eventTitle').textContent = 'Event Not Found';
                    document.getElementById('eventDescription').textContent = 'The requested event could not be found.';
                });
        }

        // Helper function to get event location (mock implementation)
        function getEventLocation(eventType) {
            const locations = {
                'MusicEvent': 'Outdoor Stage, HCMC',
                'WorkshopEvent': 'Workshop Room 1, Hanoi',
                'CompetitionEvent': 'Main Auditorium, Da Nang',
                'ConferenceEvent': 'Conference Hall, HCMC'
            };
            return locations[eventType] || 'TBA';
        }

        // Helper function to get display name for event type
        function getEventTypeDisplay(eventType) {
            const types = {
                'MusicEvent': 'Music Festival',
                'WorkshopEvent': 'Workshop',
                'CompetitionEvent': 'Competition',
                'FestivalEvent': 'Festival',
                'ConferenceEvent': 'Conference'
            };
            return types[eventType] || eventType;
        }

        // Add event-specific information
        function addEventSpecificInfo(event) {
            const eventInfo = document.getElementById('eventInfo');
            
            // Add points if available
            if (event.points) {
                const pointsElement = document.createElement('p');
                pointsElement.innerHTML = '<strong>Points:</strong> <span>' + event.points + '</span>';
                eventInfo.appendChild(pointsElement);
            }
            
            // Add event-specific details
            if (event.type === 'MusicEvent' && event.genre) {
                const genreElement = document.createElement('p');
                genreElement.innerHTML = '<strong>Genre:</strong> <span>' + event.genre + '</span>';
                eventInfo.appendChild(genreElement);
            }
            
            if (event.type === 'WorkshopEvent' && event.skillLevel) {
                const skillElement = document.createElement('p');
                skillElement.innerHTML = '<strong>Skill Level:</strong> <span>' + event.skillLevel + '</span>';
                eventInfo.appendChild(skillElement);
            }
            
            if (event.type === 'CompetitionEvent' && event.prizePool) {
                const prizeElement = document.createElement('p');
                prizeElement.innerHTML = '<strong>Prize Pool:</strong> <span>' + event.prizePool + '</span>';
                eventInfo.appendChild(prizeElement);
            }
            
            if (event.type === 'ConferenceEvent' && event.conferenceType) {
                const conferenceElement = document.createElement('p');
                conferenceElement.innerHTML = '<strong>Conference Type:</strong> <span>' + event.conferenceType + '</span>';
                eventInfo.appendChild(conferenceElement);
            }
            
            if (event.type === 'ConferenceEvent' && event.maxAttendees) {
                const attendeesElement = document.createElement('p');
                attendeesElement.innerHTML = '<strong>Max Attendees:</strong> <span>' + event.maxAttendees + '</span>';
                eventInfo.appendChild(attendeesElement);
            }
        }

        // Check if customer is authenticated
        function checkAuthentication() {
            fetch('/api/current-customer')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        currentUser = data;
                        document.getElementById('joinEventBtn').textContent = 'Join Event';
                    } else {
                        document.getElementById('joinEventBtn').textContent = 'Login to Join';
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    document.getElementById('joinEventBtn').textContent = 'Login to Join';
                });
        }

        // Handle join event button click
        function joinEvent() {
            if (currentUser) {
                // User is logged in, redirect to registration form
                window.location.href = '/event/' + eventId + '/register';
            } else {
                // User not logged in, redirect to login
                window.location.href = '/login';
            }
        }

        // Load page data
        window.onload = function() {
            loadEventDetails();
            checkAuthentication();
        };
    </script>
</body>
</html>
