
<div th:fragment="content">
    <div class="page-header">
        <div class="breadcrumbs">
            <span class="link" data-link="host" style="cursor:pointer">B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
            <i class="fas fa-chevron-right"></i>
            <span>S·ª± ki·ªán</span>
        </div>
        <div class="header-content">
            <h1 class="page-title">S·ª± ki·ªán</h1>
            <button class="btn-share">
                <i class="fas fa-share-alt"></i>
                <span>Chia s·∫ª</span>
            </button>
        </div>
    </div>

    <div class="event-search-bar">
        <input type="text" class="event-search-input" placeholder="T√¨m ki·∫øm theo t√™n s·ª± ki·ªán"/>
        <select class="event-search-select">
            <option>T·∫•t c·∫£</option>
            <option>ƒêang di·ªÖn ra</option>
            <option>S·∫Øp di·ªÖn ra</option>
            <option>ƒê√£ k·∫øt th√∫c</option>
            <option>Oldest first</option>
        </select>
        <button class="btn-create-event">
            <i class="fas fa-calendar-plus"></i> T·∫°o s·ª± ki·ªán
        </button>
    </div>

    <div class="event-tabs">
        <button class="event-tab active">S·∫Øp t·ªõi</button>
        <button class="event-tab">K·∫øt th√∫c</button>
        <button class="event-tab">L∆∞u tr·ªØ</button>
    </div>

    <div class="events-list">
        <div class="event-card" th:each="event : ${events}">
            <div class="event-image">
                <img alt="Event Image"
                     th:src="${event.imageUrl}"
                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='60'%3E%3Crect width='100%25' height='100%25' fill='%236f42c1'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Segoe UI' font-size='12'%3EEvent%3C/text%3E%3C/svg%3E">
            </div>
            <div class="event-details">
                <h3 class="event-title" th:text="${event.title}">T√™n S·ª± Ki·ªán</h3>

                <p class="event-subtitle" th:text="${event.eventType}">Lo·∫°i S·ª± Ki·ªán</p>

                <div class="event-info">
                    <div class="date-time-group">
                        <span class="date-label">B·∫Øt ƒë·∫ßu:</span>
                        <span class="date-box" th:text="${#temporals.format(event.startsAt, 'MMM dd')}"></span>
                        <span class="time"
                              th:text="|${#temporals.format(event.startsAt, 'h:mm a')}|"></span>
                    </div>

                    <div class="date-time-group">
                        <span class="date-label">K·∫øt th√∫c:</span>
                        <span class="date-box" th:text="${#temporals.format(event.endsAt, 'MMM dd')}"></span>
                        <span class="time"
                              th:text="|${#temporals.format(event.endsAt, 'h:mm a')}|"></span>
                    </div>

                    <!-- Status badge v·ªõi logic ƒë·∫ßy ƒë·ªß -->
                    <span th:if="${event.status.name() == 'DRAFT'}" 
                          class="status-badge draft"
                          th:text="'DRAFT ‚Ä¢ S·∫ÆP T·ªöI'">DRAFT ‚Ä¢ S·∫ÆP T·ªöI</span>
                    
                    <span th:if="${event.status.name() == 'CANCEL'}" 
                          class="status-badge cancel"
                          th:text="'ƒê√É H·ª¶Y'">ƒê√É H·ª¶Y</span>
                    
                    <span th:if="${event.status.name() == 'FINISH'}" 
                          class="status-badge finished"
                          th:text="'K·∫æT TH√öC'">K·∫æT TH√öC</span>
                    
                    <span th:if="${event.status.name() == 'ONGOING'}" 
                          class="status-badge live"
                          th:text="'LIVE ‚Ä¢ ƒêANG DI·ªÑN RA'">LIVE ‚Ä¢ ƒêANG DI·ªÑN RA</span>
                    
                    <!-- PUBLIC status: check th·ªùi gian -->
                    <span th:if="${event.status.name() == 'PUBLIC' && event.startsAt != null && event.startsAt.isAfter(currentTime)}" 
                          class="status-badge upcoming"
                          th:text="'PUBLIC ‚Ä¢ S·∫ÆP T·ªöI'">PUBLIC ‚Ä¢ S·∫ÆP T·ªöI</span>
                    
                    <span th:if="${event.status.name() == 'PUBLIC' && event.endsAt != null && event.endsAt.isBefore(currentTime)}" 
                          class="status-badge finished"
                          th:text="'K·∫æT TH√öC'">K·∫æT TH√öC</span>
                    
                    <span th:if="${event.status.name() == 'PUBLIC' && !(event.startsAt != null && event.startsAt.isAfter(currentTime)) && !(event.endsAt != null && event.endsAt.isBefore(currentTime))}" 
                          class="status-badge live"
                          th:text="'LIVE ‚Ä¢ ƒêANG DI·ªÑN RA'">LIVE ‚Ä¢ ƒêANG DI·ªÑN RA</span>
                </div>

                <div class="event-sales">
                    <i class="fas fa-users"></i>
                    <span th:text="|0 ƒë√£ b√°n|">0 ƒë√£ b√°n</span>
                </div>
            </div>
            <div class="event-actions">
                <button class="action-btn" th:attr="data-event-id=${event.id}">
                    <i class="fas fa-ellipsis-v"></i>
                </button>

                <div class="dropdown-menu" style="display: none;">
                    <ul>
                        <li>
                            <a th:href="@{'/event/' + ${event.id}}">
                                <i class="far fa-eye"></i> Xem trang s·ª± ki·ªán
                            </a>
                        </li>
                        <li>
                            <a th:href="@{'/manage/event/' + ${event.id}+'/getting-stared'}">
                                <i class="fas fa-cog"></i> Qu·∫£n l√Ω s·ª± ki·ªán
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fas fa-qrcode"></i> Check-in
                            </a>
                        </li>
                        <li>
                            <a href="#" class="delete-action">
                                <i class="fas fa-trash-alt"></i> L∆∞u tr·ªØ s·ª± ki·ªán
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>

            <h2>‚ú® T·∫°o s·ª± ki·ªán c·ªßa b·∫°n</h2>
            <p class="subtitle">H√£y cho ch√∫ng t√¥i bi·∫øt v·ªÅ s·ª± ki·ªán c·ªßa b·∫°n</p>

            <form th:action="@{/api/events/saveEvent}" th:object="${eventForm}" method="post">
                <label>T√™n s·ª± ki·ªán *</label>
                <input type="text" th:field="*{title}" placeholder="Nh·∫≠p t√™n s·ª± ki·ªán">

                <label>Th·ªÉ lo·∫°i s·ª± ki·ªán</label>
                <select th:field="*{eventType}">
                    <option th:each="p : ${listTypeEvent}" th:value="${p}" th:text="${p}"></option>
                </select>

                <label>M√¥ t·∫£ s·ª± ki·ªán</label>
                <textarea th:field="*{description}"
                          placeholder="H√£y cho m·ªçi ng∆∞·ªùi bi·∫øt ƒëi·ªÅu g√¨ s·∫Ω c√≥ t·∫°i s·ª± ki·ªán..."></textarea>

                <div>
                    <label>H·∫°n ƒëƒÉng k√Ω s·ª± ki·ªán</label>
                    <input th:field="*{enrollDeadline}" type="datetime-local">
                </div>

                <div class="date-time">
                    <div>
                        <label>Ng√†y & gi·ªù b·∫Øt ƒë·∫ßu *</label>
                        <input th:field="*{startsAt}" type="datetime-local">
                    </div>
                    <div>
                        <label>Ng√†y & gi·ªù k·∫øt th√∫c</label>
                        <input th:field="*{endsAt}" type="datetime-local">
                    </div>
                </div>

                <button type="submit" class="submit-btn">üìÖ Ti·∫øp t·ª•c thi·∫øt l·∫≠p</button>
            </form>
        </div>
    </div>

</div>

<script>
    // Function to initialize event form validation and modal
    function initializeEventsPage() {
        console.log('=== Initializing Events Page ===');
        
        const modal = document.getElementById('createEventModal');
        const openBtn = document.querySelector('.btn-create-event');
        const closeBtn = document.querySelector('.close');

        // Open modal
        if (openBtn) {
            // Remove existing listener to avoid duplicates
            openBtn.removeEventListener('click', handleOpenModal);
            openBtn.addEventListener('click', handleOpenModal);
        }

        function handleOpenModal() {
            console.log('Opening modal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                // Setup form validation when modal opens
                setupFormValidation();
            }
        }

        // Close modal
        function closeModal() {
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        if (closeBtn) {
            closeBtn.removeEventListener('click', closeModal);
            closeBtn.addEventListener('click', closeModal);
        }

        // Close modal when clicking outside
        if (modal) {
            modal.removeEventListener('click', handleModalClick);
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        // Setup form validation
        function setupFormValidation() {
            console.log('Setting up form validation...');
            const form = document.querySelector('#createEventModal form');
            
            if (!form) {
                console.warn('Form not found in modal');
                return;
            }

            // Remove existing listener to avoid duplicates
            form.removeEventListener('submit', handleFormSubmit);
            form.addEventListener('submit', handleFormSubmit);
        }

        function handleFormSubmit(e) {
            console.log('=== Form submit event triggered ===');
            e.preventDefault();
            
            // Find inputs by name attribute (Thymeleaf converts th:field to name)
            const form = e.target;
            const title = form.querySelector('input[name="title"]');
            const enrollDeadline = form.querySelector('input[name="enrollDeadline"]');
            const startsAt = form.querySelector('input[name="startsAt"]');
            const endsAt = form.querySelector('input[name="endsAt"]');

            console.log('Found inputs:', {
                title: !!title,
                enrollDeadline: !!enrollDeadline,
                startsAt: !!startsAt,
                endsAt: !!endsAt,
                titleValue: title?.value,
                enrollDeadlineValue: enrollDeadline?.value,
                startsAtValue: startsAt?.value,
                endsAtValue: endsAt?.value
            });

            // Validate title
            if (!title || !title.value.trim()) {
                alert('Vui l√≤ng nh·∫≠p t√™n s·ª± ki·ªán');
                if (title) title.focus();
                return false;
            }

            // Validate startsAt (required)
            if (!startsAt || !startsAt.value) {
                alert('Vui l√≤ng ch·ªçn ng√†y v√† gi·ªù b·∫Øt ƒë·∫ßu');
                if (startsAt) startsAt.focus();
                return false;
            }

            // Validate enrollDeadline < startsAt
            if (enrollDeadline && enrollDeadline.value && startsAt && startsAt.value) {
                const enrollDeadlineDate = new Date(enrollDeadline.value);
                const startsAtDate = new Date(startsAt.value);
                
                console.log('Checking enrollDeadline < startsAt:', {
                    enrollDeadline: enrollDeadline.value,
                    startsAt: startsAt.value,
                    enrollDeadlineDate: enrollDeadlineDate,
                    startsAtDate: startsAtDate,
                    isValid: enrollDeadlineDate < startsAtDate
                });
                
                if (enrollDeadlineDate >= startsAtDate) {
                    alert('H·∫°n ƒëƒÉng k√Ω s·ª± ki·ªán ph·∫£i nh·ªè h∆°n ng√†y gi·ªù b·∫Øt ƒë·∫ßu');
                    enrollDeadline.focus();
                    return false;
                }
            }

            // Validate startsAt < endsAt
            if (endsAt && endsAt.value && startsAt && startsAt.value) {
                const startsAtDate = new Date(startsAt.value);
                const endsAtDate = new Date(endsAt.value);
                
                console.log('Checking startsAt < endsAt:', {
                    startsAt: startsAt.value,
                    endsAt: endsAt.value,
                    startsAtDate: startsAtDate,
                    endsAtDate: endsAtDate,
                    isValid: startsAtDate < endsAtDate
                });
                
                if (startsAtDate >= endsAtDate) {
                    alert('Ng√†y gi·ªù b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ng√†y gi·ªù k·∫øt th√∫c');
                    startsAt.focus();
                    return false;
                }
            }

            // Validate enrollDeadline < endsAt (if both are provided)
            if (enrollDeadline && enrollDeadline.value && endsAt && endsAt.value) {
                const enrollDeadlineDate = new Date(enrollDeadline.value);
                const endsAtDate = new Date(endsAt.value);
                
                console.log('Checking enrollDeadline < endsAt:', {
                    enrollDeadline: enrollDeadline.value,
                    endsAt: endsAt.value,
                    enrollDeadlineDate: enrollDeadlineDate,
                    endsAtDate: endsAtDate,
                    isValid: enrollDeadlineDate < endsAtDate
                });
                
                if (enrollDeadlineDate >= endsAtDate) {
                    alert('H·∫°n ƒëƒÉng k√Ω s·ª± ki·ªán ph·∫£i nh·ªè h∆°n ng√†y gi·ªù k·∫øt th√∫c');
                    enrollDeadline.focus();
                    return false;
                }
            }

            console.log('‚úÖ Form validation passed, submitting form...');
            // If validation passes, submit the form
            form.submit();
            return true;
        }

        // Setup form validation immediately
        setupFormValidation();
    }

    // Initialize when script runs (for SPA router)
    initializeEventsPage();

    // Also initialize when DOM is ready (fallback)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeEventsPage);
    } else {
        // DOM already loaded
        initializeEventsPage();
    }

    // Expose globally for SPA router
    window.initializeEventsPage = initializeEventsPage;
</script>

