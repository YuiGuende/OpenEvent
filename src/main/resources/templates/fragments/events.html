
<div th:fragment="content">
    <div class="page-header">
        <div class="breadcrumbs">
            <span class="link" data-link="host" style="cursor:pointer">B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
            <i class="fas fa-chevron-right"></i>
            <span>S·ª± ki·ªán</span>
        </div>
        <div class="header-content">
            <h1 class="page-title">S·ª± ki·ªán</h1>
            <button class="btn-share">
                <i class="fas fa-share-alt"></i>
                <span>Chia s·∫ª</span>
            </button>
        </div>
    </div>

    <div class="event-search-bar">
        <input type="text" id="eventSearchInput" class="event-search-input" 
               placeholder="T√¨m ki·∫øm theo t√™n s·ª± ki·ªán"
               th:value="${searchValue}"/>
        <select id="eventSortFilter" class="event-search-select">
            <option value="">T·∫•t c·∫£</option>
            <option value="ONGOING" th:selected="${sortFilterValue == 'ONGOING'}">ƒêang di·ªÖn ra</option>
            <option value="UPCOMING" th:selected="${sortFilterValue == 'UPCOMING'}">S·∫Øp di·ªÖn ra</option>
            <option value="FINISHED" th:selected="${sortFilterValue == 'FINISHED'}">ƒê√£ k·∫øt th√∫c</option>
            <option value="OLDEST_FIRST" th:selected="${sortFilterValue == 'OLDEST_FIRST'}">Oldest first</option>
        </select>
        <button class="btn-create-event">
            <i class="fas fa-calendar-plus"></i> T·∫°o s·ª± ki·ªán
        </button>
    </div>

    <div class="events-list">
        <!-- Empty state when no events -->
        <div th:if="${events == null || events.isEmpty()}" 
             class="events-empty" 
             style="text-align: center; padding: 60px 20px; color: #999;">
            <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
            <p style="font-size: 18px; margin: 0;">
                <span th:if="${(searchValue != null && !searchValue.isEmpty()) || (sortFilterValue != null && !sortFilterValue.isEmpty() && sortFilterValue != '')}">
                    Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán ph√π h·ª£p v·ªõi b·ªô l·ªçc c·ªßa b·∫°n
                </span>
                <span th:unless="${(searchValue != null && !searchValue.isEmpty()) || (sortFilterValue != null && !sortFilterValue.isEmpty() && sortFilterValue != '')}">
                    B·∫°n ch∆∞a c√≥ s·ª± ki·ªán n√†o. H√£y t·∫°o s·ª± ki·ªán ƒë·∫ßu ti√™n!
                </span>
            </p>
        </div>
        
        <div class="event-card" th:each="event : ${events}">
            <div class="event-image">
                <img alt="Event Image"
                     th:src="${event.imageUrl}"
                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='60'%3E%3Crect width='100%25' height='100%25' fill='%236f42c1'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Segoe UI' font-size='12'%3EEvent%3C/text%3E%3C/svg%3E">
            </div>
            <div class="event-details">
                <h3 class="event-title" th:text="${event.title}">T√™n S·ª± Ki·ªán</h3>

                <p class="event-subtitle" th:text="${event.eventType}">Lo·∫°i S·ª± Ki·ªán</p>

                <div class="event-info">
                    <div class="date-time-group">
                        <span class="date-label">B·∫Øt ƒë·∫ßu:</span>
                        <span class="date-box" th:text="${#temporals.format(event.startsAt, 'MMM dd')}"></span>
                        <span class="time"
                              th:text="|${#temporals.format(event.startsAt, 'h:mm a')}|"></span>
                    </div>

                    <div class="date-time-group">
                        <span class="date-label">K·∫øt th√∫c:</span>
                        <span class="date-box" th:text="${#temporals.format(event.endsAt, 'MMM dd')}"></span>
                        <span class="time"
                              th:text="|${#temporals.format(event.endsAt, 'h:mm a')}|"></span>
                    </div>

                    <!-- Status badge: So s√°nh v·ªõi th·ªùi gian th·ª±c (currentTime), kh√¥ng ch·ªâ status trong DB -->
                    <!-- CANCEL v√† FINISH: Lu√¥n hi·ªÉn th·ªã tr·∫°ng th√°i t·ª´ DB (kh√¥ng ph·ª• thu·ªôc th·ªùi gian) -->
                    <span th:if="${event.status.name() == 'CANCEL'}" 
                          class="status-badge cancel"
                          th:text="'ƒê√É H·ª¶Y'">ƒê√É H·ª¶Y</span>
                    
                    <span th:if="${event.status.name() == 'FINISH'}" 
                          class="status-badge finished"
                          th:text="'K·∫æT TH√öC'">K·∫æT TH√öC</span>
                    
                    <!-- V·ªõi c√°c status kh√°c (DRAFT, PUBLIC, ONGOING): So s√°nh v·ªõi th·ªùi gian th·ª±c -->
                    <th:block th:if="${event.status.name() != 'CANCEL' && event.status.name() != 'FINISH'}">
                        <!-- N·∫øu c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin th·ªùi gian: So s√°nh v·ªõi currentTime -->
                        <th:block th:if="${event.startsAt != null && event.endsAt != null}">
                            <!-- Event ƒë√£ k·∫øt th√∫c: endsAt < currentTime -->
                            <span th:if="${event.endsAt.isBefore(currentTime)}" 
                                  class="status-badge finished"
                                  th:text="'K·∫æT TH√öC'">K·∫æT TH√öC</span>
                            
                            <!-- Event s·∫Øp di·ªÖn ra: startsAt > currentTime -->
                            <span th:if="${(event.endsAt.isAfter(currentTime) || event.endsAt.isEqual(currentTime)) and event.startsAt.isAfter(currentTime)}" 
                                  class="status-badge upcoming"
                                  th:text="${event.status.name() == 'PUBLIC' 
                                             ? 'PUBLIC ‚Ä¢ S·∫ÆP T·ªöI' 
                                             : 'DRAFT ‚Ä¢ S·∫ÆP T·ªöI'}">S·∫ÆP T·ªöI</span>
                            
                            <!-- Event ƒëang di·ªÖn ra: startsAt <= currentTime <= endsAt -->
                            <span th:if="${(event.endsAt.isAfter(currentTime) || event.endsAt.isEqual(currentTime)) 
                                           and (event.startsAt.isBefore(currentTime) || event.startsAt.isEqual(currentTime))}" 
                                  class="status-badge live"
                                  th:text="${event.status.name() == 'PUBLIC' || event.status.name() == 'ONGOING' 
                                             ? 'LIVE ‚Ä¢ ƒêANG DI·ªÑN RA' 
                                             : 'DRAFT ‚Ä¢ ƒêANG DI·ªÑN RA'}">ƒêANG DI·ªÑN RA</span>
                        </th:block>
                        
                        <!-- Fallback: N·∫øu thi·∫øu th√¥ng tin th·ªùi gian, hi·ªÉn th·ªã d·ª±a v√†o status t·ª´ DB -->
                        <span th:if="${event.startsAt == null || event.endsAt == null}" 
                              class="status-badge draft"
                              th:text="${event.status.name() == 'PUBLIC' 
                                         ? 'PUBLIC ‚Ä¢ S·∫ÆP T·ªöI' 
                                         : 'DRAFT ‚Ä¢ S·∫ÆP T·ªöI'}">S·∫ÆP T·ªöI</span>
                    </th:block>
                </div>

                <div class="event-sales">
                    <i class="fas fa-users"></i>
                    <span th:text="|0 ƒë√£ b√°n|">0 ƒë√£ b√°n</span>
                </div>
            </div>
            <div class="event-actions">
                <button class="action-btn" th:attr="data-event-id=${event.id}">
                    <i class="fas fa-ellipsis-v"></i>
                </button>

                <div class="dropdown-menu" style="display: none;">
                    <ul>
                        <li>
                            <!-- Dynamic URL based on event type -->
                            <a th:href="${event.eventType.name() == 'WORKSHOP' ? '/workshop/' + event.id : 
                                         event.eventType.name() == 'MUSIC' ? '/music/' + event.id : 
                                         event.eventType.name() == 'COMPETITION' ? '/competition/' + event.id : 
                                         event.eventType.name() == 'FESTIVAL' ? '/festival/' + event.id : 
                                         '/event/' + event.id}">
                                <i class="far fa-eye"></i> Xem trang s·ª± ki·ªán
                            </a>
                        </li>
                        <li>
                            <a th:href="@{'/manage/event/' + ${event.id}+'/getting-stared'}">
                                <i class="fas fa-cog"></i> Qu·∫£n l√Ω s·ª± ki·ªán
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fas fa-qrcode"></i> Check-in
                            </a>
                        </li>
                        <li>
                            <a href="#" class="delete-event-action" 
                               th:attr="data-event-id=${event.id}, data-event-title=${event.title}">
                                <i class="fas fa-trash-alt"></i> X√≥a s·ª± ki·ªán
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>

            <h2>‚ú® T·∫°o s·ª± ki·ªán c·ªßa b·∫°n</h2>
            <p class="subtitle">H√£y cho ch√∫ng t√¥i bi·∫øt v·ªÅ s·ª± ki·ªán c·ªßa b·∫°n</p>

            <form th:action="@{/api/events/saveEvent}" th:object="${eventForm}" method="post">
                <label>T√™n s·ª± ki·ªán *</label>
                <input type="text" th:field="*{title}" placeholder="Nh·∫≠p t√™n s·ª± ki·ªán">

                <label>Th·ªÉ lo·∫°i s·ª± ki·ªán</label>
                <select th:field="*{eventType}">
                    <option th:each="p : ${listTypeEvent}" th:value="${p}" th:text="${p}"></option>
                </select>

                <label>M√¥ t·∫£ s·ª± ki·ªán</label>
                <textarea th:field="*{description}"
                          placeholder="H√£y cho m·ªçi ng∆∞·ªùi bi·∫øt ƒëi·ªÅu g√¨ s·∫Ω c√≥ t·∫°i s·ª± ki·ªán..."></textarea>

                <div>
                    <label>H·∫°n ƒëƒÉng k√Ω s·ª± ki·ªán</label>
                    <input th:field="*{enrollDeadline}" type="datetime-local">
                </div>

                <div class="date-time">
                    <div>
                        <label>Ng√†y & gi·ªù b·∫Øt ƒë·∫ßu *</label>
                        <input name="" th:field="*{startsAt}" type="datetime-local">
                    </div>
                    <div>
                        <label>Ng√†y & gi·ªù k·∫øt th√∫c</label>
                        <input th:field="*{endsAt}" type="datetime-local">
                    </div>
                </div>

                <button type="submit" class="submit-btn">üìÖ Ti·∫øp t·ª•c thi·∫øt l·∫≠p</button>
            </form>
        </div>
    </div>

    <script th:inline="none">
        (function() {
            'use strict';
            
            // Handle delete event action (dropdown is handled by event.js)
            function initializeDeleteEvent() {
                // Use event delegation to handle dynamically added delete links
                document.addEventListener('click', function(event) {
                    const deleteLink = event.target.closest('.delete-event-action');
                    if (!deleteLink) return;
                    
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    
                    const eventId = deleteLink.getAttribute('data-event-id');
                    const eventTitle = deleteLink.getAttribute('data-event-title') || 's·ª± ki·ªán n√†y';
                    
                    // Close dropdown
                    const dropdownMenu = deleteLink.closest('.dropdown-menu');
                    if (dropdownMenu) {
                        dropdownMenu.style.display = 'none';
                    }
                    
                    // Show confirmation dialog
                    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán "' + eventTitle + '" kh√¥ng?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                        deleteEvent(eventId, deleteLink);
                    }
                });
            }
            
            // Delete event via API
            function deleteEvent(eventId, deleteLink) {
                // Find the event card
                const eventCard = deleteLink ? deleteLink.closest('.event-card') : null;
                
                if (!deleteLink) {
                    console.error('Delete link not found for event:', eventId);
                    return;
                }
                
                // Show loading state
                const originalHTML = deleteLink.innerHTML;
                deleteLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√≥a...';
                deleteLink.style.pointerEvents = 'none';
                deleteLink.style.opacity = '0.6';
                
                fetch('/api/events/' + eventId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Kh√¥ng th·ªÉ x√≥a s·ª± ki·ªán');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Show success message
                    alert('ƒê√£ x√≥a s·ª± ki·ªán th√†nh c√¥ng!');
                    
                    // Remove event card from DOM with animation
                    if (eventCard) {
                        eventCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        eventCard.style.opacity = '0';
                        eventCard.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            eventCard.remove();
                            
                            // Check if there are no more events
                            const eventsList = document.querySelector('.events-list');
                            if (eventsList) {
                                const remainingEvents = eventsList.querySelectorAll('.event-card');
                                if (remainingEvents.length === 0) {
                                    // Show empty state
                                    const emptyState = eventsList.querySelector('.events-empty');
                                    if (!emptyState) {
                                        eventsList.innerHTML = `
                                            <div class="events-empty" style="text-align: center; padding: 60px 20px; color: #999;">
                                                <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                                <p style="font-size: 18px; margin: 0;">
                                                    B·∫°n ch∆∞a c√≥ s·ª± ki·ªán n√†o. H√£y t·∫°o s·ª± ki·ªán ƒë·∫ßu ti√™n!
                                                </p>
                                            </div>
                                        `;
                                    } else {
                                        emptyState.style.display = 'block';
                                    }
                                }
                            }
                            
                            // Reload the page to refresh the events list and update server state
                            window.location.reload();
                        }, 300);
                    } else {
                        // If event card not found, just reload
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error deleting event:', error);
                    alert('L·ªói: ' + error.message);
                    
                    // Restore original button state
                    deleteLink.innerHTML = originalHTML;
                    deleteLink.style.pointerEvents = 'auto';
                    deleteLink.style.opacity = '1';
                });
            }
            
            // Initialize delete event handler (dropdown is handled by event.js)
            // Use a flag to prevent multiple initializations
            if (!window.deleteEventInitialized) {
                window.deleteEventInitialized = true;
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeDeleteEvent);
                } else {
                    initializeDeleteEvent();
                }
            }
            
            // Re-initialize dropdowns after fragment loads (event.js will handle it)
            if (typeof window.initEventDropdowns === 'function') {
                // Small delay to ensure DOM is ready
                setTimeout(function() {
                    window.initEventDropdowns();
                }, 50);
            }
        })();
    </script>

</div>


