
<div th:fragment="content">
    <div class="page-header">
        <div class="breadcrumbs">
            <span class="link" data-link="host" style="cursor:pointer">Dashboard</span>
            <i class="fas fa-chevron-right"></i>
            <span>Events</span>
        </div>
        <div class="header-content">
            <h1 class="page-title">Events</h1>
            <button class="btn-share">
                <i class="fas fa-share-alt"></i>
                <span>Share</span>
            </button>
        </div>
    </div>

    <div class="event-search-bar">
        <input type="text" id="eventSearchInput" class="event-search-input" 
               placeholder="Search by event name"
               th:value="${searchValue}"/>
        <select id="eventSortFilter" class="event-search-select">
            <option value="">All</option>
            <option value="ONGOING" th:selected="${sortFilterValue == 'ONGOING'}">Ongoing</option>
            <option value="UPCOMING" th:selected="${sortFilterValue == 'UPCOMING'}">Upcoming</option>
            <option value="FINISHED" th:selected="${sortFilterValue == 'FINISHED'}">Finished</option>
            <option value="OLDEST_FIRST" th:selected="${sortFilterValue == 'OLDEST_FIRST'}">Oldest first</option>
        </select>
        <button class="btn-create-event">
            <i class="fas fa-calendar-plus"></i> Create Event
        </button>
    </div>

    <div class="events-list">
        <!-- Empty state when no events -->
        <div th:if="${events == null || events.isEmpty()}" 
             class="events-empty" 
             style="text-align: center; padding: 60px 20px; color: #999;">
            <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
            <p style="font-size: 18px; margin: 0;">
                <span th:if="${(searchValue != null && !searchValue.isEmpty()) || (sortFilterValue != null && !sortFilterValue.isEmpty() && sortFilterValue != '')}">
                    No events found matching your filters
                </span>
                <span th:unless="${(searchValue != null && !searchValue.isEmpty()) || (sortFilterValue != null && !sortFilterValue.isEmpty() && sortFilterValue != '')}">
                    You don't have any events yet. Create your first event!
                </span>
            </p>
        </div>
        
        <div class="event-card" th:each="event : ${events}">
            <div class="event-image">
                <img alt="Event Image"
                     th:src="${event.imageUrl}"
                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='60'%3E%3Crect width='100%25' height='100%25' fill='%236f42c1'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Segoe UI' font-size='12'%3EEvent%3C/text%3E%3C/svg%3E">
            </div>
            <div class="event-details">
                <h3 class="event-title" th:text="${event.title}">Event Name</h3>

                <p class="event-subtitle" th:text="${event.eventType}">Event Type</p>

                <div class="event-info">
                    <div class="date-time-group">
                        <span class="date-label">Start:</span>
                        <span class="date-box" th:text="${#temporals.format(event.startsAt, 'MMM dd')}"></span>
                        <span class="time"
                              th:text="|${#temporals.format(event.startsAt, 'h:mm a')}|"></span>
                    </div>

                    <div class="date-time-group">
                        <span class="date-label">End:</span>
                        <span class="date-box" th:text="${#temporals.format(event.endsAt, 'MMM dd')}"></span>
                        <span class="time"
                              th:text="|${#temporals.format(event.endsAt, 'h:mm a')}|"></span>
                    </div>

                    <!-- Status badge: So sÃ¡nh vá»›i thá»i gian thá»±c (currentTime), khÃ´ng chá»‰ status trong DB -->
                    <!-- CANCEL vÃ  FINISH: LuÃ´n hiá»ƒn thá»‹ tráº¡ng thÃ¡i tá»« DB (khÃ´ng phá»¥ thuá»™c thá»i gian) -->
                    <span th:if="${event.status.name() == 'CANCEL'}" 
                          class="status-badge cancel"
                          th:text="'CANCELLED'">CANCELLED</span>
                    
                    <span th:if="${event.status.name() == 'FINISH'}" 
                          class="status-badge finished"
                          th:text="'FINISHED'">FINISHED</span>
                    
                    <!-- Vá»›i cÃ¡c status khÃ¡c (DRAFT, PUBLIC, ONGOING): So sÃ¡nh vá»›i thá»i gian thá»±c -->
                    <th:block th:if="${event.status.name() != 'CANCEL' && event.status.name() != 'FINISH'}">
                        <!-- Náº¿u cÃ³ Ä‘áº§y Ä‘á»§ thÃ´ng tin thá»i gian: So sÃ¡nh vá»›i currentTime -->
                        <th:block th:if="${event.startsAt != null && event.endsAt != null}">
                            <!-- Event Ä‘Ã£ káº¿t thÃºc: endsAt < currentTime -->
                            <span th:if="${event.endsAt.isBefore(currentTime)}" 
                                  class="status-badge finished"
                                  th:text="'FINISHED'">FINISHED</span>
                            
                            <!-- Event sáº¯p diá»…n ra: startsAt > currentTime -->
                            <span th:if="${(event.endsAt.isAfter(currentTime) || event.endsAt.isEqual(currentTime)) and event.startsAt.isAfter(currentTime)}" 
                                  class="status-badge upcoming"
                                  th:text="${event.status.name() == 'PUBLIC' 
                                             ? 'PUBLIC â€¢ UPCOMING' 
                                             : 'DRAFT â€¢ UPCOMING'}">UPCOMING</span>
                            
                            <!-- Event Ä‘ang diá»…n ra: startsAt <= currentTime <= endsAt -->
                            <span th:if="${(event.endsAt.isAfter(currentTime) || event.endsAt.isEqual(currentTime)) 
                                           and (event.startsAt.isBefore(currentTime) || event.startsAt.isEqual(currentTime))}" 
                                  class="status-badge live"
                                  th:text="${event.status.name() == 'PUBLIC' || event.status.name() == 'ONGOING' 
                                             ? 'LIVE â€¢ ONGOING' 
                                             : 'DRAFT â€¢ ONGOING'}">ONGOING</span>
                        </th:block>
                        
                        <!-- Fallback: Náº¿u thiáº¿u thÃ´ng tin thá»i gian, hiá»ƒn thá»‹ dá»±a vÃ o status tá»« DB -->
                        <span th:if="${event.startsAt == null || event.endsAt == null}" 
                              class="status-badge draft"
                              th:text="${event.status.name() == 'PUBLIC' 
                                         ? 'PUBLIC â€¢ UPCOMING' 
                                         : 'DRAFT â€¢ UPCOMING'}">UPCOMING</span>
                    </th:block>
                </div>

                <div class="event-sales">
                    <i class="fas fa-users"></i>
                    <span th:text="|${ticketsSoldMap != null && ticketsSoldMap.containsKey(event.id) ? ticketsSoldMap.get(event.id) : 0} sold|">0 sold</span>
                </div>
            </div>
            <div class="event-actions">
                <button class="action-btn" th:attr="data-event-id=${event.id}">
                    <i class="fas fa-ellipsis-v"></i>
                </button>

                <div class="dropdown-menu" style="display: none;">
                    <ul>
                        <li>
                            <!-- Dynamic URL based on event type -->
                            <a th:href="${event.eventType.name() == 'WORKSHOP' ? '/workshop/' + event.id : 
                                         event.eventType.name() == 'MUSIC' ? '/music/' + event.id : 
                                         event.eventType.name() == 'COMPETITION' ? '/competition/' + event.id : 
                                         event.eventType.name() == 'FESTIVAL' ? '/festival/' + event.id : 
                                         '/event/' + event.id}">
                                <i class="far fa-eye"></i> View Event Page
                            </a>
                        </li>
                        <li>
                            <a th:href="@{'/manage/event/' + ${event.id}+'/getting-stared'}">
                                <i class="fas fa-cog"></i> Manage Event
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fas fa-qrcode"></i> Check-in
                            </a>
                        </li>
                        <li>
                            <a href="#" class="delete-event-action" 
                               th:attr="data-event-id=${event.id}, data-event-title=${event.title}">
                                <i class="fas fa-trash-alt"></i> Delete Event
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>

            <h2>âœ¨ Create Your Event</h2>
            <p class="subtitle">Tell us about your event</p>

            <form th:action="@{/api/events/saveEvent}" th:object="${eventForm}" method="post">
                <label>Event Name *</label>
                <input type="text" th:field="*{title}" placeholder="Enter event name">

                <label>Event Type</label>
                <select th:field="*{eventType}">
                    <option th:each="p : ${listTypeEvent}" th:value="${p}" th:text="${p}"></option>
                </select>

                <label>Event Description</label>
                <textarea th:field="*{description}"
                          placeholder="Tell everyone what will be at the event..."></textarea>

                <div>
                    <label>Event Registration Deadline</label>
                    <input th:field="*{enrollDeadline}" type="datetime-local">
                </div>

                <div class="date-time">
                    <div>
                        <label>Start Date & Time *</label>
                        <input name="" th:field="*{startsAt}" type="datetime-local">
                    </div>
                    <div>
                        <label>End Date & Time</label>
                        <input th:field="*{endsAt}" type="datetime-local">
                    </div>
                </div>

                <button type="submit" class="submit-btn">ðŸ“… Continue Setup</button>
            </form>
        </div>
    </div>

    <script th:inline="none">
        (function() {
            'use strict';
            
            // Handle delete event action (dropdown is handled by event.js)
            function initializeDeleteEvent() {
                // Use event delegation to handle dynamically added delete links
                document.addEventListener('click', function(event) {
                    const deleteLink = event.target.closest('.delete-event-action');
                    if (!deleteLink) return;
                    
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    
                    const eventId = deleteLink.getAttribute('data-event-id');
                    const eventTitle = deleteLink.getAttribute('data-event-title') || 'this event';
                    
                    // Close dropdown
                    const dropdownMenu = deleteLink.closest('.dropdown-menu');
                    if (dropdownMenu) {
                        dropdownMenu.style.display = 'none';
                    }
                    
                    // Show confirmation dialog
                    if (confirm('Are you sure you want to delete the event "' + eventTitle + '"?\n\nThis action cannot be undone!')) {
                        deleteEvent(eventId, deleteLink);
                    }
                });
            }
            
            // Delete event via API
            function deleteEvent(eventId, deleteLink) {
                // Find the event card
                const eventCard = deleteLink ? deleteLink.closest('.event-card') : null;
                
                if (!deleteLink) {
                    console.error('Delete link not found for event:', eventId);
                    return;
                }
                
                // Show loading state
                const originalHTML = deleteLink.innerHTML;
                deleteLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                deleteLink.style.pointerEvents = 'none';
                deleteLink.style.opacity = '0.6';
                
                fetch('/api/events/' + eventId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Unable to delete event');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Show success message
                    alert('Event deleted successfully!');
                    
                    // Remove event card from DOM with animation
                    if (eventCard) {
                        eventCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        eventCard.style.opacity = '0';
                        eventCard.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            eventCard.remove();
                            
                            // Check if there are no more events
                            const eventsList = document.querySelector('.events-list');
                            if (eventsList) {
                                const remainingEvents = eventsList.querySelectorAll('.event-card');
                                if (remainingEvents.length === 0) {
                                    // Show empty state
                                    const emptyState = eventsList.querySelector('.events-empty');
                                    if (!emptyState) {
                                        eventsList.innerHTML = `
                                            <div class="events-empty" style="text-align: center; padding: 60px 20px; color: #999;">
                                                <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                                <p style="font-size: 18px; margin: 0;">
                                                    You don't have any events yet. Create your first event!
                                                </p>
                                            </div>
                                        `;
                                    } else {
                                        emptyState.style.display = 'block';
                                    }
                                }
                            }
                            
                            // Reload the page to refresh the events list and update server state
                            window.location.reload();
                        }, 300);
                    } else {
                        // If event card not found, just reload
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error deleting event:', error);
                    alert('Error: ' + error.message);
                    
                    // Restore original button state
                    deleteLink.innerHTML = originalHTML;
                    deleteLink.style.pointerEvents = 'auto';
                    deleteLink.style.opacity = '1';
                });
            }
            
            // Initialize delete event handler (dropdown is handled by event.js)
            // Use a flag to prevent multiple initializations
            if (!window.deleteEventInitialized) {
                window.deleteEventInitialized = true;
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeDeleteEvent);
                } else {
                    initializeDeleteEvent();
                }
            }
            
            // Re-initialize dropdowns after fragment loads (event.js will handle it)
            if (typeof window.initEventDropdowns === 'function') {
                // Small delay to ensure DOM is ready
                setTimeout(function() {
                    window.initEventDropdowns();
                }, 50);
            }
        })();
    </script>

</div>


