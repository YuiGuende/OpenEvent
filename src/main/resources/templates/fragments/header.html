<header class="site-header" th:fragment="siteHeader(page)">
    <div class="container header-inner">
        <!-- Logo -->
        <a class="logo" href="index.html" th:href="@{/}">
            <img th:src="@{/img/logo1.png}" alt="OpenEvent"/>
            <span>OpenEvent</span>
        </a>
        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html" th:href="@{/}" class="nav-link"
               th:classappend="${page == 'home'} ? ' is-active'">Home</a>
            <a href="about.html" th:href="@{/about}" class="nav-link"
               th:classappend="${page == 'about'} ? ' is-active'">About</a>
            <a href="speakers.html" th:href="@{/speakers}" class="nav-link"
               th:classappend="${page == 'speakers'} ? ' is-active'">Speakers</a>
            <a href="faq.html" th:href="@{/faq}" class="nav-link"
               th:classappend="${page == 'faq'} ? ' is-active'">FAQ</a>
            <a href="sponsors.html" th:href="@{/sponsors}" class="nav-link"
               th:classappend="${page == 'sponsors'} ? ' is-active'">Sponsors</a>
            <a href="pricing.html" th:href="@{/pricing}" class="nav-link"
               th:classappend="${page == 'pricing'} ? ' is-active'">Pricing</a>
            <a href="contact.html" th:href="@{/contact}" class="nav-link"
               th:classappend="${page == 'contact'} ? ' is-active'">Contact</a>
        </nav>
        <!-- Actions -->
        <div class="customer-actions" style="display:flex; align-items:center; gap:12px;">
            <a class="btn btn-ghost" href="create-event.html" th:href="@{/events?create=true}">Create Event</a>
            <a id="loginLink" class="btn btn-primary" href="login.html" th:href="@{/login}">Log in</a>
            <div id="userMenu" class="user-menu" style="display:none; position: relative;">
                <button id="userBtn" class="btn btn-primary user-trigger user-button" type="button">
                    <span id="userAvatar" class="avatar user-avatar">U</span>
                    <span id="userName" class="user-name">User</span>
                    <span id="notificationDot" class="notification-dot" style="display:none;"></span>
                </button>
                <div id="userDropdown" class="dropdown"
                     style="display:none; position:absolute; right:0; top:50px; min-width:220px; background:#fff; border:1px solid #e5e7eb; box-shadow:0 8px 24px rgba(0,0,0,0.12); border-radius:12px; overflow:hidden; z-index:1000;">
                    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f1f5f9;">
                        Account
                    </div>
                    <a href="/orders" class="dropdown-item"
                       style="display:block; padding:10px 12px; text-decoration:none; color:#111827;">My orders</a>
                    <a href="/user" class="dropdown-item"
                       style="display:block; padding:10px 12px; text-decoration:none; color:#111827;">My profile</a>
                    <a href="/notifications" id="notificationMenuItem" class="dropdown-item notification-menu-item"
                       style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; text-decoration:none; color:#111827;">
                        <span>Notifications</span>
                        <span id="notificationBadge" class="notification-badge" style="display:none;">0</span>
                    </a>
                    <div style="border-top:1px solid #f1f5f9;"></div>
                    <a href="#" id="logoutAction" class="dropdown-item"
                       style="display:block; padding:10px 12px; text-decoration:none; color:#ef4444; font-weight:600;">Sign
                        out</a>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var login = document.getElementById('loginLink');
                var menu = document.getElementById('userMenu');
                var btn = document.getElementById('userBtn');
                var dd = document.getElementById('userDropdown');
                var nameEl = document.getElementById('userName');
                var av = document.getElementById('userAvatar');
                var logout = document.getElementById('logoutAction');

                function closeDropdown() {
                    if (dd) dd.style.display = 'none';
                }

                function toggleDropdown(e) {
                    e.preventDefault();
                    if (!dd) return;
                    dd.style.display = (dd.style.display === 'none' || dd.style.display === '') ? 'block' : 'none';
                }

                function outside(e) {
                    if (!menu) return;
                    if (!menu.contains(e.target)) closeDropdown();
                }

                // Bind events
                if (btn) btn.addEventListener('click', toggleDropdown);
                document.addEventListener('click', outside);
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') closeDropdown();
                });

                if (logout) {
                    logout.addEventListener('click', function (e) {
                        e.preventDefault();
                        closeDropdown();
                        fetch('/api/logout', {method: 'POST'})
                            .then(function () {
                                window.location.reload();
                            })
                            .catch(function () {
                                window.location.reload();
                            });
                    });
                }

                // Function to format user display name
                function formatUserDisplay(email, accountId) {
                    if (email) {
                        // Extract username part (before @) and limit to 6 characters
                        var username = email.split('@')[0];
                        var shortName = username.length > 6 ? username.substring(0, 6) : username;
                        return 'Hello, ' + shortName;
                    }
                    return 'User #' + (accountId || '');
                }

                // Load notification count
                function loadNotificationCount() {
                    fetch('/api/notifications/unread-count', {credentials: 'include'})
                        .then(function (r) {
                            return r.ok ? r.json() : {count: 0};
                        })
                        .then(function (data) {
                            var count = data.count || 0;
                            var dot = document.getElementById('notificationDot');
                            var badge = document.getElementById('notificationBadge');
                            
                            if (count > 0) {
                                if (dot) dot.style.display = 'block';
                                if (badge) {
                                    badge.style.display = 'inline-flex';
                                    badge.textContent = count > 99 ? '99+' : count;
                                }
                            } else {
                                if (dot) dot.style.display = 'none';
                                if (badge) badge.style.display = 'none';
                            }
                        })
                        .catch(function () { /* ignore */ });
                }

                // Initialize WebSocket for realtime notifications
                function initWebSocket() {
                    try {
                        // Check if SockJS is available
                        if (typeof SockJS === 'undefined') {
                            console.log('SockJS not loaded, skipping WebSocket initialization');
                            return;
                        }
                        
                        var accountId = null;
                        fetch('/api/current-user', {credentials: 'include'})
                            .then(function (r) { return r.ok ? r.json() : {authenticated: false}; })
                            .then(function (data) {
                                if (data && data.authenticated && data.accountId) {
                                    accountId = data.accountId;
                                    
                                    var socket = new SockJS('/ws');
                                    var stompClient = Stomp.over(socket);
                                    
                                    stompClient.connect({}, function() {
                                        console.log('WebSocket connected for notifications');
                                        
                                        // Subscribe to user's notification queue
                                        stompClient.subscribe('/queue/notifications/' + accountId, function(message) {
                                            var notification = JSON.parse(message.body);
                                            console.log('Received notification:', notification);
                                            
                                            // Update notification count
                                            loadNotificationCount();
                                            
                                            // Show browser notification (optional)
                                            if (Notification.permission === 'granted') {
                                                new Notification(notification.title || 'New Notification', {
                                                    body: notification.message,
                                                    icon: '/img/logo1.png'
                                                });
                                            }
                                        });
                                    }, function(error) {
                                        console.error('WebSocket connection error:', error);
                                    });
                                    
                                    // Store client for cleanup
                                    window.stompClient = stompClient;
                                }
                            })
                            .catch(function() { /* ignore */ });
                    } catch (e) {
                        console.error('WebSocket initialization error:', e);
                    }
                }

                // Fetch current user once
                fetch('/api/current-user').then(function (r) {
                    return r.ok ? r.json() : {authenticated: false};
                })
                    .then(function (data) {
                        if (data && data.authenticated) {
                            if (login) login.style.display = 'none';
                            if (menu) menu.style.display = '';
                            var display = formatUserDisplay(data.email, data.accountId);
                            if (nameEl) nameEl.textContent = display;
                            if (av) {
                                var initial = data.email ? data.email.split('@')[0].charAt(0) : 'U';
                                av.textContent = initial.toUpperCase();
                            }
                            
                            // Load notification count and init WebSocket
                            loadNotificationCount();
                            initWebSocket();
                            
                            // Refresh notification count every 30 seconds
                            setInterval(loadNotificationCount, 30000);
                        } else {
                            if (login) login.style.display = '';
                            if (menu) menu.style.display = 'none';
                        }
                    })
                    .catch(function () { /* ignore */
                    });
            });
        </script>

        <style>
            /* Ensure Create Event button keeps original style */
            .customer-actions .btn-ghost {
                /* Keep original Create Event button style intact */
                display: inline-block !important;
            }

            /* User button base styles */
            .user-button {
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                border-radius: 999px !important;
                padding: 8px 12px !important;
                height: 40px !important;
                line-height: 24px !important;
                min-width: auto !important;
            }

            .user-avatar {
                width: 24px !important;
                height: 24px !important;
                border-radius: 50% !important;
                background: rgba(255,255,255,0.25) !important;
                color: #ffffff !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-weight: 700 !important;
                font-size: 12px !important;
                flex-shrink: 0 !important;
            }

            .user-name {
                max-width: 120px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                color: #ffffff !important;
                font-size: 14px !important;
                font-weight: 500 !important;
            }

            .user-arrow {
                display: inline-block !important;
                transform: translateY(1px) !important;
                color: #ffffff !important;
                font-size: 12px !important;
                flex-shrink: 0 !important;
            }

            /* Responsive breakpoints */
            @media (max-width: 768px) {
                .user-button {
                    gap: 6px !important;
                    padding: 6px 8px !important;
                }

                .user-name {
                    max-width: 80px !important;
                    font-size: 13px !important;
                }

                .user-avatar {
                    width: 20px !important;
                    height: 20px !important;
                    font-size: 11px !important;
                }

                .user-arrow {
                    font-size: 10px !important;
                }
            }

            @media (max-width: 480px) {
                .user-button {
                    gap: 4px !important;
                    padding: 5px 6px !important;
                }

                .user-name {
                    max-width: 50px !important;
                    font-size: 12px !important;
                }

                .user-avatar {
                    width: 18px !important;
                    height: 18px !important;
                    font-size: 10px !important;
                }
            }

            @media (max-width: 360px) {
                .user-name {
                    display: none !important;
                }

                .user-button {
                    padding: 6px !important;
                    gap: 0 !important;
                    min-width: 32px !important;
                    justify-content: center !important;
                }

                .user-arrow {
                    display: none !important;
                }
            }

            /* Notification dot on user button */
            .notification-dot {
                position: absolute;
                top: 4px;
                right: 4px;
                width: 8px;
                height: 8px;
                background: #ef4444;
                border-radius: 50%;
                border: 2px solid #fff;
                z-index: 10;
            }

            .user-button {
                position: relative;
            }

            /* Notification badge in dropdown */
            .notification-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 20px;
                height: 20px;
                padding: 0 6px;
                background: #ef4444;
                color: #ffffff;
                border-radius: 10px;
                font-size: 11px;
                font-weight: 600;
                line-height: 1;
            }

            .notification-menu-item:hover {
                background: #f9fafb;
            }
        </style>
    </div>
</header>