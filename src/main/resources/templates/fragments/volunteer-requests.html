<!-- Main Content -->
<div class="container" th:fragment="content">
    <!-- Error when missing event ID -->
    <div th:if="${error != null and error == 'Missing event ID'}" class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Lỗi:</strong> Thiếu thông tin event ID. Vui lòng truy cập từ trang quản lý sự kiện.
    </div>
    
    <div class="row" th:if="${error == null or error != 'Missing event ID'}">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="page-header mb-4">
                        <h2 class="card-title mb-2">
                            <i class="bi bi-clipboard-check"></i> Yêu cầu duyệt Tình nguyện viên
                        </h2>
                        <p class="text-muted" th:if="${event != null}">
                            Sự kiện: <strong th:text="${event.title}">Event Name</strong>
                        </p>
                        <p class="text-muted" th:if="${event == null and error != null}">
                            <strong th:text="${error}">Error</strong>
                        </p>
                    </div>

                    <!-- Success Message -->
                    <div th:if="${param.success != null}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle-fill"></i> 
                        <span th:if="${param.success[0] == 'approved'}">Đã chấp nhận ứng viên!</span>
                        <span th:if="${param.success[0] == 'rejected'}">Đã từ chối ứng viên!</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    
                    <!-- Error Message -->
                    <div th:if="${param.error != null}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <span th:text="${param.error[0]}">Error message</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                    <!-- Volunteer Form Info -->
                    <div th:if="${form != null}" class="alert alert-info mb-4" role="alert">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle"></i> Form: <span th:text="${form.formTitle}">Form Title</span>
                        </h6>
                        <p class="mb-0 small" th:text="${form.formDescription != null ? form.formDescription : 'Không có mô tả'}">
                            Form description
                        </p>
                    </div>

                    <!-- No Form Warning -->
                    <div th:if="${form == null}" class="alert alert-warning mb-4" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Chưa có form tình nguyện viên!</strong> Vui lòng tạo form trước khi xem yêu cầu duyệt.
                        <a th:href="@{'/manage/event/' + ${eventId} + '/volunteer-create-form'}" 
                           class="btn btn-sm btn-info ms-2" data-link>
                            <i class="bi bi-file-earmark-plus"></i> Tạo Form
                        </a>
                    </div>

                    <!-- Volunteer Applications Table -->
                    <div class="form-type-section">
                        <div class="form-type-header register">
                            <h3><i class="bi bi-people"></i> Danh sách yêu cầu đăng ký Tình nguyện viên</h3>
                            <p class="mb-0">Tổng số: <span th:text="${groupedResponses != null ? groupedResponses.size() : 0}">0</span> ứng viên</p>
                        </div>

                        <div th:if="${groupedResponses == null or groupedResponses.isEmpty()}" class="empty-state text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                            <h4 class="mt-3">Chưa có yêu cầu nào</h4>
                            <p class="text-muted">Chưa có ứng viên nào nộp đơn đăng ký tình nguyện viên cho sự kiện này.</p>
                        </div>

                        <div th:if="${groupedResponses != null and !groupedResponses.isEmpty()}" class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th><i class="bi bi-person"></i> Ứng viên</th>
                                        <th><i class="bi bi-envelope"></i> Email</th>
                                        <th><i class="bi bi-question-circle"></i> Câu trả lời</th>
                                        <th><i class="bi bi-clock"></i> Thời gian nộp</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="entry, iterStat : ${groupedResponses}">
                                        <td th:text="${iterStat.index + 1}">1</td>
                                        <td>
                                            <strong th:text="${entry.value[0].customerName ?: 'N/A'}">Name</strong>
                                        </td>
                                        <td>
                                            <span th:text="${entry.value[0].customerEmail ?: 'N/A'}">email@example.com</span>
                                        </td>
                                        <td>
                                            <div class="response-list">
                                                <div th:each="response : ${entry.value}" th:if="${!#lists.isEmpty(entry.value)}" class="mb-2">
                                                    <strong class="text-primary" th:text="${response.questionText ?: 'N/A'}">Question:</strong>
                                                    <span th:text="${response.responseValue ?: 'N/A'}">Response</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted"
                                                   th:text="${entry.value[0].submittedAt != null ? #temporals.format(entry.value[0].submittedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">
                                                01/01/2024 12:00
                                            </small>
                                        </td>
                                        <td>
                                            <form th:action="@{/manage/volunteers/approve-by-customer}" method="post" style="display:inline;">
                                                <input type="hidden" name="eventId" th:value="${eventId}">
                                                <input type="hidden" name="formId" th:value="${formId}">
                                                <input type="hidden" name="customerId" th:value="${entry.key}">
                                                <button type="submit" class="btn btn-success btn-sm">
                                                    <i class="bi bi-check-circle"></i> Chấp nhận
                                                </button>
                                            </form>
                                            <form th:action="@{/manage/volunteers/reject-by-customer}" method="post" style="display:inline; margin-left:6px;">
                                                <input type="hidden" name="eventId" th:value="${eventId}">
                                                <input type="hidden" name="formId" th:value="${formId}">
                                                <input type="hidden" name="customerId" th:value="${entry.key}">
                                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                                    <i class="bi bi-x-circle"></i> Từ chối
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .page-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 15px;
    }
    
    .form-type-section {
        margin-bottom: 30px;
    }
    
    .form-type-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .form-type-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .form-type-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
    }
    
    .response-list {
        max-width: 400px;
    }
    
    .response-list div {
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .response-list div:last-child {
        border-bottom: none;
    }
    
    .empty-state {
        padding: 40px 20px;
    }
    
    .table th {
        font-weight: 600;
        white-space: nowrap;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>

