<div th:fragment="content">
    <div class="page-header">
        <div class="breadcrumbs">
            <span>Quản lý</span>
            <i class="fas fa-chevron-right"></i>
            <span>Ví</span>
        </div>
        <div class="header-content">
            <h1 class="page-title">Ví của tôi</h1>
        </div>
    </div>

    <!-- Wallet Balance Cards (chỉ hiển thị khi đã có ví) -->
    <div class="metrics-grid" id="wallet-balance-cards" style="display: none;">
        <div class="metric-card">
            <div class="metric-icon blue">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="available-balance">0 ₫</div>
                <div class="metric-label">Số dư khả dụng</div>
            </div>
        </div>
    </div>

    <!-- Create Wallet Form Section (hiển thị khi chưa có ví) -->
    <div class="wallet-section" id="create-wallet-section" style="display: none;">
        <div class="section-header">
            <h2 class="section-title">Tạo ví</h2>
            <p class="section-description">Vui lòng làm KYC và nhập thông tin tài khoản ngân hàng để tạo ví</p>
        </div>

        <form id="create-wallet-form" class="withdrawal-form">
            <div class="form-group">
                <label for="kyc-name">Tên từ KYC <span class="required">*</span></label>
                <input type="text" id="kyc-name" class="form-control" readonly>
                <small class="form-text">Tên được lấy từ kết quả KYC của bạn</small>
            </div>

            <div class="form-group">
                <label for="create-bank-name">Tên ngân hàng <span class="required">*</span></label>
                <select id="create-bank-name" name="bankCode" class="form-control" required>
                    <option value="">-- Chọn ngân hàng --</option>
                    <option value="VCB">Vietcombank (VCB)</option>
                    <option value="TCB">Techcombank (TCB)</option>
                    <option value="ACB">ACB</option>
                    <option value="BIDV">BIDV</option>
                    <option value="VTB">VietinBank (VTB)</option>
                    <option value="TPB">TPBank (TPB)</option>
                    <option value="VPB">VPBank (VPB)</option>
                    <option value="MB">MB Bank (MB)</option>
                    <option value="MBB">MBBank (MBB)</option>
                    <option value="MSB">MSB</option>
                    <option value="OCB">OCB</option>
                    <option value="SHB">SHB</option>
                    <option value="VAB">VietABank (VAB)</option>
                    <option value="HDB">HDBank (HDB)</option>
                    <option value="STB">Sacombank (STB)</option>
                    <option value="SCB">SCB</option>
                    <option value="EXIM">Eximbank (EXIM)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="create-bank-account">Số tài khoản ngân hàng <span class="required">*</span></label>
                <input type="text" id="create-bank-account" name="bankAccountNumber" class="form-control"
                       placeholder="Nhập số tài khoản" required pattern="[0-9]+"
                       minlength="3" maxlength="20">
                <small class="form-text">Vui lòng nhập đúng số tài khoản ngân hàng</small>
                <small class="form-text text-muted">Mock: STK 123 + MB -> NGUYEN TRAN THANH DUY, STK 321 + MB -> LE HUYNH DUC</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary" id="submit-create-wallet">
                    <i class="fas fa-check"></i>
                    Xác nhận tạo ví
                </button>
                <a href="/kyc-verification" class="btn-secondary" style="margin-left: 10px;">
                    <i class="fas fa-id-card"></i>
                    Làm KYC
                </a>
            </div>
        </form>
    </div>

    <!-- Withdrawal Form Section (hiển thị khi đã có ví) -->
    <div class="wallet-section" id="withdrawal-section" style="display: none;">
        <div class="section-header">
            <h2 class="section-title">Rút tiền</h2>
            <p class="section-description">Thông tin ngân hàng đã được lưu trong ví của bạn</p>
        </div>

        <!-- Bank Info Display -->
        <div class="bank-info-display" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">Thông tin ngân hàng</h4>
            <p><strong>Ngân hàng:</strong> <span id="display-bank-code"></span></p>
            <p><strong>Số tài khoản:</strong> <span id="display-bank-account"></span></p>
            <p><strong>Chủ tài khoản:</strong> <span id="display-account-holder"></span></p>
        </div>

        <form id="withdrawal-form" class="withdrawal-form">
            <div class="form-group">
                <label for="withdrawal-amount">Số tiền muốn rút (₫) <span class="required">*</span></label>
                <input type="number" id="withdrawal-amount" name="amount" class="form-control"
                       placeholder="Nhập số tiền" required min="10000" step="1000">
                <small class="form-text">Số tiền tối thiểu: 10,000 ₫</small>
                <div class="quick-amounts">
                    <button type="button" class="btn-quick-amount" onclick="setAmount(100000)">100K</button>
                    <button type="button" class="btn-quick-amount" onclick="setAmount(500000)">500K</button>
                    <button type="button" class="btn-quick-amount" onclick="setAmount(1000000)">1M</button>
                    <button type="button" class="btn-quick-amount" onclick="setMaxAmount()">Tất cả</button>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary" id="submit-withdrawal">
                    <i class="fas fa-paper-plane"></i>
                    Xác nhận rút tiền
                </button>
            </div>
        </form>
    </div>

    <!-- Transaction History Section -->
    <div class="wallet-section">
        <div class="section-header">
            <h2 class="section-title">Lịch sử giao dịch</h2>
        </div>

        <div class="transaction-filter">
            <button class="filter-btn active" data-filter="all">Tất cả</button>
            <button class="filter-btn" data-filter="INCOME">Nạp tiền</button>
            <button class="filter-btn" data-filter="PAYOUT">Rút tiền</button>
        </div>

        <div class="transaction-list" id="transaction-list">
            <div class="loading-state" id="loading-transactions">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Đang tải...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('=== WALLET.HTML SCRIPT LOADED ===');
        console.log('Script execution started at:', new Date().toISOString());

        // Make variables and functions global so they can be called from host.js
        window.currentHostId = null;
        window.availableBalance = 0;
        window.walletExists = false;
        console.log('Global variables initialized');

        // Global function to initialize wallet - can be called from host.js
        window.initWallet = function () {
            console.log('=== initWallet CALLED ===');
            console.log('Current hostId:', window.currentHostId);
            console.log('Available balance:', window.availableBalance);

            // Setup forms
            setupForms();

            // Setup filter buttons
            setupFilterButtons();

            // Load wallet info first to determine which form to show
            loadWalletInfo();
        };

        // Load wallet info to check if wallet exists
        async function loadWalletInfo() {
            try {
                console.log('Loading wallet info...');
                const response = await fetch('/api/wallet/info', {
                    method: 'GET',
                    credentials: 'include', // Include cookies for session
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (!response.ok) {
                    // Try to parse error response
                    let errorData;
                    try {
                        const errorText = await response.text();
                        console.error('Error response text:', errorText);
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: 'Unknown error' };
                    }
                    
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication error:', errorData);
                        // Show error message and suggest login
                        document.getElementById('create-wallet-section').style.display = 'block';
                        document.getElementById('withdrawal-section').style.display = 'none';
                        document.getElementById('wallet-balance-cards').style.display = 'none';
                        
                        const kycNameInput = document.getElementById('kyc-name');
                        if (kycNameInput) {
                            kycNameInput.value = 'Vui lòng đăng nhập lại';
                            kycNameInput.style.color = '#dc3545';
                        }
                        
                        // Show error message
                        const errorMsg = errorData.message || errorData.error || 'Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.';
                        alert('Lỗi: ' + errorMsg);
                        return;
                    }
                    
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('Wallet info received:', data);

                if (data.success) {
                    window.currentHostId = data.hostId;
                    window.walletExists = data.exists === true;

                    if (data.exists) {
                        // Wallet exists - show withdrawal form
                        showWithdrawalForm(data);
                    } else {
                        // Wallet does not exist - show create wallet form
                        showCreateWalletForm(data);
                    }
                } else {
                    console.error('Failed to load wallet info:', data.message);
                    // Show create wallet form with error message
                    showCreateWalletForm(data);
                    if (data.message) {
                        alert('Lỗi: ' + data.message);
                    }
                }
            } catch (error) {
                console.error('Error loading wallet info:', error);
                // Show create wallet form with error state
                document.getElementById('create-wallet-section').style.display = 'block';
                document.getElementById('withdrawal-section').style.display = 'none';
                document.getElementById('wallet-balance-cards').style.display = 'none';
                
                const kycNameInput = document.getElementById('kyc-name');
                if (kycNameInput) {
                    kycNameInput.value = 'Lỗi khi tải thông tin';
                    kycNameInput.style.color = '#dc3545';
                }
                
                alert('Lỗi khi tải thông tin ví: ' + error.message + '. Vui lòng thử lại sau hoặc đăng nhập lại.');
            }
        }

        // Show withdrawal form (when wallet exists)
        function showWithdrawalForm(walletData) {
            document.getElementById('create-wallet-section').style.display = 'none';
            document.getElementById('withdrawal-section').style.display = 'block';
            document.getElementById('wallet-balance-cards').style.display = 'block';

            // Update balance
            const availBalance = parseFloat(walletData.availableBalance || 0);
            window.availableBalance = availBalance;
            document.getElementById('available-balance').textContent = formatCurrency(availBalance);

            // Update bank info display
            document.getElementById('display-bank-code').textContent = walletData.bankCode || 'N/A';
            document.getElementById('display-bank-account').textContent = walletData.bankAccountNumber || 'N/A';
            document.getElementById('display-account-holder').textContent = walletData.accountHolderName || 'N/A';

            // Show transaction history section
            const transactionSections = document.querySelectorAll('.wallet-section');
            if (transactionSections.length > 0) {
                const lastSection = transactionSections[transactionSections.length - 1];
                if (lastSection && lastSection.id !== 'create-wallet-section' && lastSection.id !== 'withdrawal-section') {
                    lastSection.style.display = 'block';
                }
            }

            // Load transaction history
            if (typeof window.loadTransactionHistory === 'function') {
                window.loadTransactionHistory();
            }
        }

        // Show create wallet form (when wallet does not exist)
        function showCreateWalletForm(walletData) {
            document.getElementById('create-wallet-section').style.display = 'block';
            document.getElementById('withdrawal-section').style.display = 'none';
            document.getElementById('wallet-balance-cards').style.display = 'none';

            // Set KYC name if available
            const kycNameInput = document.getElementById('kyc-name');
            if (kycNameInput && walletData.kycName) {
                kycNameInput.value = walletData.kycName;
                kycNameInput.style.color = '#000';
            } else if (kycNameInput && !walletData.kycName) {
                kycNameInput.value = 'Chưa có KYC';
                kycNameInput.style.color = '#dc3545';
            }

            // Hide transaction history section if wallet doesn't exist
            const transactionSections = document.querySelectorAll('.wallet-section');
            if (transactionSections.length > 0) {
                const lastSection = transactionSections[transactionSections.length - 1];
                if (lastSection && lastSection.id !== 'create-wallet-section' && lastSection.id !== 'withdrawal-section') {
                    lastSection.style.display = 'none';
                }
            }
        }

        // Setup forms
        function setupForms() {
            // Setup create wallet form
            const createWalletForm = document.getElementById('create-wallet-form');
            if (createWalletForm) {
                createWalletForm.addEventListener('submit', handleCreateWallet);
            }

            // Setup withdrawal form
            const withdrawalForm = document.getElementById('withdrawal-form');
            if (withdrawalForm) {
                withdrawalForm.addEventListener('submit', handleWithdrawal);
            }
        }

        // Define formatCurrency before using it
        function formatCurrency(amount) {
            if (!amount || amount === 0 || isNaN(amount)) {
                return '0 ₫';
            }
            // Convert to number if string
            const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(numAmount);
        }

        // Make formatCurrency global
        window.formatCurrency = formatCurrency;
        console.log('formatCurrency function defined and made global');

        // Handle create wallet form submission
        async function handleCreateWallet(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const bankAccountNumber = formData.get('bankAccountNumber');
            const bankCode = formData.get('bankCode');

            if (!bankAccountNumber || !bankCode) {
                alert('Vui lòng điền đầy đủ thông tin ngân hàng');
                return;
            }

            const kycName = document.getElementById('kyc-name').value;
            if (!kycName || kycName === 'Chưa có KYC') {
                alert('Vui lòng làm KYC trước khi tạo ví');
                return;
            }

            const submitBtn = document.getElementById('submit-create-wallet');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

            try {
                const payload = {
                    bankAccountNumber: bankAccountNumber,
                    bankCode: bankCode
                };

                const response = await fetch('/api/wallet/create', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = { success: false, message: responseText || 'Lỗi không xác định' };
                }

                if (response.ok && data.success) {
                    alert('Tạo ví thành công!');
                    // Reload wallet info to show withdrawal form
                    await loadWalletInfo();
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể tạo ví. Vui lòng thử lại.'));
                }
            } catch (error) {
                console.error('Error creating wallet:', error);
                alert('Có lỗi xảy ra khi tạo ví: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Xác nhận tạo ví';
            }
        }

        window.loadTransactionHistory = async function (filter = 'all') {
            const container = document.getElementById('transaction-list');
            if (!container) {
                console.error('Transaction list container not found');
                return;
            }

            // Show loading state
            container.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><p>Đang tải...</p></div>';

            try {
                console.log('Loading transactions with filter:', filter);
                const response = await fetch(`/api/wallet/transactions?filter=${filter}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Transaction API error:', response.status, errorText);
                    throw new Error(`Network response was not ok: ${response.status}`);
                }

                const data = await response.json();
                console.log('Transaction data received:', data);

                if (data.success) {
                    displayTransactions(data.transactions || []);
                } else {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>' + (data.message || 'Không thể tải lịch sử giao dịch') + '</p></div>';
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Lỗi khi tải lịch sử giao dịch. Vui lòng thử lại sau.</p></div>';
            }
        };

        function displayTransactions(transactions) {
            const container = document.getElementById('transaction-list');

            if (!transactions || transactions.length === 0) {
                container.innerHTML =
                    '<div class="empty-state"><i class="fas fa-inbox"></i><p>Chưa có giao dịch nào</p></div>';
                return;
            }

            container.innerHTML = transactions.map(txn => `
        <div class="transaction-item">
            <div class="transaction-info">
                <div class="transaction-type">
                    ${txn.transactionType === 'INCOME' ? 'Nạp tiền' : 'Rút tiền'}
                    <span class="transaction-status status-${txn.status.toLowerCase()}">${getStatusText(txn.status)}</span>
                </div>
                <div class="transaction-desc">${txn.description || 'Giao dịch'}</div>
                <div class="transaction-date">${formatDate(txn.createdAt)}</div>
            </div>
            <div class="transaction-amount ${txn.transactionType === 'INCOME' ? 'income' : 'payout'}">
                ${txn.transactionType === 'INCOME' ? '+' : '-'}${formatCurrency(txn.amount)}
            </div>
        </div>
    `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'COMPLETED': 'Thành công',
                'PENDING': 'Đang xử lý',
                'FAILED': 'Thất bại'
            };
            return statusMap[status] || status;
        }

        // formatCurrency already defined above, no need to redefine

        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        window.setAmount = function (amount) {
            const amountInput = document.getElementById('withdrawal-amount');
            if (amountInput) {
                amountInput.value = amount;
            }
        };

        window.setMaxAmount = function () {
            const amountInput = document.getElementById('withdrawal-amount');
            if (amountInput) {
                amountInput.value = window.availableBalance || 0;
            }
        };

        async function handleWithdrawal(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const amount = parseFloat(formData.get('amount'));

            if (!window.currentHostId) {
                alert('Không tìm thấy thông tin host. Vui lòng đăng nhập lại.');
                return;
            }

            if (amount > window.availableBalance) {
                alert('Số tiền rút vượt quá số dư khả dụng!');
                return;
            }

            if (amount < 10000) {
                alert('Số tiền rút tối thiểu là 10,000 ₫');
                return;
            }

            const submitBtn = document.getElementById('submit-withdrawal');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

            try {
                // Only send amount, bank info is retrieved from wallet
                const payload = {
                    amount: amount
                };

                const response = await fetch(`/api/payout/${window.currentHostId}/request-withdraw`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                let data;
                try {
                    const responseText = await response.text();
                    if (responseText) {
                        data = JSON.parse(responseText);
                    } else {
                        data = {};
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    data = { message: response.ok ? 'Yêu cầu rút tiền đã được xử lý nhưng không nhận được phản hồi chi tiết.' : 'Lỗi khi xử lý phản hồi từ server.' };
                }

                if (response.ok && (data.id || data.payosOrderCode)) {
                    // Success - reload data immediately
                    console.log('Payout request successful:', data);
                    alert('Yêu cầu rút tiền đã được gửi thành công!');
                    form.reset();
                    
                    // Reload wallet info to update balance
                    await loadWalletInfo();
                } else {
                    // Error
                    const errorMsg = typeof data === 'string' ? data : (data.message || data.error || 'Không thể thực hiện rút tiền. Vui lòng thử lại.');
                    alert('Lỗi: ' + errorMsg);
                }
            } catch (error) {
                console.error('Error during payout request:', error);
                alert('Có lỗi xảy ra khi gửi yêu cầu rút tiền: ' + error.message + '. Vui lòng thử lại sau.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Xác nhận rút tiền';
            }
        }

        // Setup filter buttons - called after DOM is ready
        function setupFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                // Remove existing listeners
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', function () {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const filter = this.getAttribute('data-filter');
                    if (typeof window.loadTransactionHistory === 'function') {
                        window.loadTransactionHistory(filter);
                    }
                });
            });
        }

        // Auto-initialize when script loads
        setTimeout(function () {
            function tryInit() {
                if (typeof window.initWallet === 'function') {
                    console.log('Wallet elements found, initializing...');
                    window.initWallet();
                    return true;
                }
                return false;
            }

            // Try immediately
            if (!tryInit()) {
                // Retry after delay if not ready
                let retries = 0;
                const maxRetries = 10;
                const retryInterval = setInterval(function () {
                    if (tryInit() || retries >= maxRetries) {
                        clearInterval(retryInterval);
                    }
                    retries++;
                }, 100);
            }
        }, 200);

        console.log('=== WALLET.HTML SCRIPT EXECUTION COMPLETE ===');
        console.log('All functions defined:');
        console.log('- window.initWallet:', typeof window.initWallet);
        console.log('- window.loadTransactionHistory:', typeof window.loadTransactionHistory);
        console.log('- window.formatCurrency:', typeof window.formatCurrency);
        console.log('- window.setAmount:', typeof window.setAmount);
        console.log('- window.setMaxAmount:', typeof window.setMaxAmount);
    </script>

