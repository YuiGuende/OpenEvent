    <!DOCTYPE html>
    <html lang="en"
          xmlns:th="http://www.thymeleaf.org"
    >
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Open.Event</title>
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
        <!-- Cropper.js -->

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
        <link rel="stylesheet" href="/css/getting-stared.css">
        <link rel="stylesheet" href="/css/create-event.css">
        <link rel="stylesheet" href="/css/update-ticket.css">
        <link rel="stylesheet" href="/css/orders.css">
        <link rel="stylesheet" href="/css/dashboard-event.css">
        <link rel="stylesheet" href="/css/event-attendees.css">

        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

        <!-- ApexCharts CDN -->
        <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest/dist/apexcharts.min.js"></script>
    </head>
    <body>
    <div class="wrapper">
        <!-- Sidebar Fragment -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <img src="/img/logo1.png" alt="Open.Event Logo">
                    </div>
                    <span class="logo-text">Open.Event</span>
                </div>
                <button class="btn-toggle-sidebar d-lg-none" id="sidebarToggleMobile">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

<!--            <div class="sidebar-status">-->
<!--                <div class="status-badge">-->
<!--                    <i class="bi bi-broadcast"></i>-->
<!--                    <span>Live</span>-->
<!--                    <small>Enter to remove</small>-->
<!--                </div>-->
<!--            </div>-->

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">OVERVIEW</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/getting-started'}" class="nav-link" data-link>
                                <i class="bi bi-star"></i>
                                <span>Started</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/dashboard-event'}" class="nav-link" data-link>
                                <i class="bi bi-grid"></i>
                                <span>Control panel</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">QU·∫¢N L√ù</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/settings'}" class="nav-link" data-link>
                                <i class="bi bi-gear"></i>
                                <span>MANAGE</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/attendees'}" class="nav-link" data-link>
                                <i class="bi bi-people"></i>
                                <span>Participants</span>
                                <span class="badge" id="participantsBadge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/volunteers'}" class="nav-link" data-link>
                                <i class="bi bi-people-fill"></i>
                                <span>Volunteer</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/orders'}" class="nav-link" data-link>
                                <i class="bi bi-receipt"></i>
                                <span>Order</span>
                                <span class="badge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/ticket'}" class="nav-link" data-link>
                                <i class="bi bi-ticket-perforated"></i>
                                <span>Ticket</span>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/request-form'}" class="nav-link" data-link>
                                <i class="fas fa-paper-plane"></i>
                                <span>Request approval</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/check-in-list'}" class="nav-link" data-link>
                                <i class="bi bi-list-check"></i>
                                <span>Check-In List</span>
                            </a>
                        </li>
<!--                        <li class="nav-item">-->
<!--                            <a href="#" class="nav-link">-->
<!--                                <i class="bi bi-tag"></i>-->
<!--                                <span>M√£ khuy·∫øn m√£i</span>-->
<!--                            </a>-->
<!--                        </li>-->
                    </ul>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">FORM MANAGEMENT</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/statis-forms'}" class="nav-link" data-link>
                                <i class="bi bi-bar-chart"></i>
                                <span>Form Statistics</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/create-forms'}" class="nav-link" data-link>
                                <i class="bi bi-file-earmark-plus"></i>
                                <span>Create Form</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/qr-codes'}" class="nav-link" data-link>
                                <i class="bi bi-qr-code"></i>
                                <span>QR Codes</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">T√åNH NGUY·ªÜN VI√äN</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/volunteer-create-form'}" class="nav-link" data-link>
                                <i class="bi bi-file-earmark-plus"></i>
                                <span>T·∫°o Form</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/volunteer-requests'}" class="nav-link" data-link>
                                <i class="bi bi-clipboard-check"></i>
                                <span>Xem y√™u c·∫ßu duy·ªát</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">NOTIFICATION</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a th:href="@{'/manage/event/' + ${eventId} + '/notification'}" class="nav-link" data-link>
                                <i class="bi bi-bell"></i>
                                <span>Notification</span>
                                <span>Th√¥ng b√°o</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{'/event-chat?eventId=' + ${eventId}}" class="nav-link">
                                <i class="bi bi-chat-dots"></i>
                                <span>Chat v·ªõi Volunteer</span>
                            </a>
                        </li>
                    </ul>
                </div>

<!--                <div class="nav-section">-->
<!--                    <div class="nav-section-title">C√îNG C·ª§</div>-->
<!--                    <ul class="nav-list">-->
<!--                        <li class="nav-item">-->
<!--                            <a href="/manage/events/homepage-designer" class="nav-link">-->
<!--                                <i class="bi bi-palette"></i>-->
<!--                                <span>Thi·∫øt k·∫ø trang s·ª± ki·ªán</span>-->
<!--                            </a>-->
<!--                        </li>-->
<!--                    </ul>-->
<!--                </div>-->
            </nav>

            <button class="btn-collapse-sidebar d-none d-lg-flex" id="sidebarCollapse" title="Thu g·ªçn/M·ªü r·ªông sidebar">
                <i class="bi bi-chevron-left"></i>
            </button>
        </aside>

        <div id="main-wrapper">
            <header class="main-header">
                <div class="header-left">
                    <button class="btn-toggle-sidebar" id="sidebarToggle">
                        <i class="bi bi-list"></i>
                    </button>

                    <nav class="breadcrumb-nav">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="#"><i class="bi bi-house-door"></i> Trang ch·ªß</a>
                            </li>
                            <li class="breadcrumb-item active">edqd</li>
                        </ol>
                    </nav>
                </div>
                <a th:href="@{/}" class="btn btn-homepage">
                    <i class="fas fa-home"></i>
                    Back to home page
                </a>
                <div class="header-right">
                    <a th:href="@{/organizer}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-box-arrow-up-right"></i>
                        Back to Host page
                    </a>


                    <div class="dropdown">
                        <button class="btn btn-icon" data-bs-toggle="dropdown" id="userDropdownBtn">
                            <i class="bi bi-person-circle"></i>
                            <span class="d-none d-md-inline" id="userDisplayName">DL</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header" id="userNameHeader">User</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Ti·∫øng Vi·ªát</a></li>
                            <li><a class="dropdown-item" href="#">English</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Main Content Fragment -->
            <main id="main-content" class="main-content">
                <div th:replace="~{__${content}__}"></div>
                <!-- Content will be loaded dynamically by SPA router -->
            </main>


        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Thymeleaf s·∫Ω t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi List<Speaker> th√†nh m·ªôt m·∫£ng ƒë·ªëi t∆∞·ª£ng JavaScript
        const initialSpeakersData = /*[[${speakersData}]]*/ [];
        const initialSchedulesData = /*[[${schedulesData}]]*/ [];
        const initialImagesData = /*[[${imagesData}]]*/ [];
        const initialPlacesData = /*[[${allPlaces}]]*/ [];
        const initialTicketTypesData = /*[[${allTicketTypes}]]*/ [];

        console.log('D·ªØ li·ªáu speakers t·ª´ Thymeleaf:', initialSpeakersData);
        console.log('D·ªØ li·ªáu schedules t·ª´ Thymeleaf:', initialSchedulesData);
        console.log('D·ªØ li·ªáu images t·ª´ Thymeleaf:', initialImagesData);
        console.log('D·ªØ li·ªáu places t·ª´ Thymeleaf:', initialPlacesData);
        console.log('D·ªØ li·ªáu ticket types t·ª´ Thymeleaf:', initialTicketTypesData);
        /*]]>*/
    </script>
    <script src="/js/orders.js"></script>
    <script src="/js/dashboard-event.js"></script>
    <script src="/js/getting-started.js"></script>
    <script src="/js/event-form.js"></script>
    <script src="/js/lineup-manager.js?v=15"></script>
    <script src="/js/agenda-manager.js?v=7"></script>
    <script src="/js/image-manager.js?v=1"></script>
    <script src="/js/place-manager.js"></script>
    <script src="/js/request-form.js"></script>
    <script src="/js/sidebar-manager.js"></script>
    <script src="/js/update-event.js"></script>
    <script src="/js/router.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/update-ticket.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script src="/js/event-attendees.js"></script>

    <script>
        // Load and display user name and avatar in header
        function loadUserName() {
            fetch('/api/current-user')
                .then(response => response.json())
                .then(data => {
                    if (data && data.authenticated && data.name) {
                        const userDisplayNameEl = document.getElementById('userDisplayName');
                        const userNameHeaderEl = document.getElementById('userNameHeader');
                        const userDropdownBtn = document.getElementById('userDropdownBtn');
                        const userIcon = userDropdownBtn ? userDropdownBtn.querySelector('i') : null;

                        if (userDisplayNameEl) {
                            // Display name, limit to 15 characters for display
                            const displayName = data.name.length > 15 ? data.name.substring(0, 15) + '...' : data.name;
                            userDisplayNameEl.textContent = displayName;
                        }

                        if (userNameHeaderEl) {
                            userNameHeaderEl.textContent = data.name;
                        }
                        
                        // Update avatar: if avatar URL exists, replace icon with image; otherwise show initial letter
                        if (userDropdownBtn && data.avatar && data.avatar.trim() !== '') {
                            // Remove icon and add avatar image
                            if (userIcon) {
                                userIcon.style.display = 'none';
                            }
                            // Create or update avatar image
                            let avatarImg = userDropdownBtn.querySelector('img.avatar-img');
                            if (!avatarImg) {
                                avatarImg = document.createElement('img');
                                avatarImg.className = 'avatar-img';
                                avatarImg.style.width = '32px';
                                avatarImg.style.height = '32px';
                                avatarImg.style.borderRadius = '50%';
                                avatarImg.style.objectFit = 'cover';
                                userDropdownBtn.insertBefore(avatarImg, userIcon);
                            }
                            avatarImg.src = data.avatar;
                            avatarImg.alt = data.name;
                        } else if (userDisplayNameEl) {
                            // Show initial letter if no avatar
                            if (!userDisplayNameEl.textContent || userDisplayNameEl.textContent.length === 0) {
                                const initial = data.name.charAt(0).toUpperCase();
                                userDisplayNameEl.textContent = initial;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading user name:', error);
                });
        }

        // Load user name when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadUserName);
        } else {
            loadUserName();
        }

        // Load event statistics (orders and participants count)
        // Make it available globally so router can call it
        window.loadEventStats = function(retryCount = 0) {
            // Get eventId from URL if not available from Thymeleaf
            let eventId = /*[[${eventId}]]*/ null;

            // Fallback: Try to get eventId from URL path
            if (!eventId) {
                const pathParts = window.location.pathname.split('/');
                const eventIdIndex = pathParts.indexOf('event');
                if (eventIdIndex !== -1 && pathParts[eventIdIndex + 1]) {
                    eventId = parseInt(pathParts[eventIdIndex + 1]);
                    if (isNaN(eventId)) {
                        eventId = null;
                    }
                }
            }

            console.log('Loading event stats for eventId:', eventId);
            if (!eventId) {
                console.warn('Event ID not found, skipping stats load');
                // Retry after 500ms if badges not found (max 5 retries)
                if (retryCount < 5) {
                    setTimeout(() => window.loadEventStats(retryCount + 1), 500);
                }
                return;
            }

            // Helper function to update badge with retry logic
            function updateBadge(badgeId, count, apiName) {
                const badge = document.getElementById(badgeId);
                if (badge) {
                    badge.textContent = count || 0;
                    console.log(`‚úÖ Updated ${apiName} badge to:`, count || 0);
                    return true;
                } else {
                    console.warn(`‚ö†Ô∏è ${badgeId} element not found. Retry: ${retryCount}/5`);
                    // Retry if badge not found (max 5 retries)
                    if (retryCount < 5) {
                        setTimeout(() => window.loadEventStats(retryCount + 1), 500);
                    }
                    return false;
                }
            }

            // Load participants count
            console.log('üìä Fetching participants count from:', `/api/events/${eventId}/participants/count`);
            fetch(`/api/events/${eventId}/participants/count`)
                .then(response => {
                    console.log('üìä Participants API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Participants API response data:', data);
                    if (data && data.success !== false) {
                        updateBadge('participantsBadge', data.count, 'Participants');
                    } else {
                        console.error('‚ùå Error loading participants count:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error fetching participants count:', error);
                });

            // Load orders count
            console.log('üì¶ Fetching orders count from:', `/api/events/${eventId}/orders/count`);
            fetch(`/api/events/${eventId}/orders/count`)
                .then(response => {
                    console.log('üì¶ Orders API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üì¶ Orders API response data:', data);
                    if (data && data.success !== false) {
                        updateBadge('ordersBadge', data.count, 'Orders');
                    } else {
                        console.error('‚ùå Error loading orders count:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error fetching orders count:', error);
                });
        };

        // Load event stats when page loads - with delay to ensure DOM is ready
        function initLoadEventStats() {
            // Wait a bit to ensure DOM is fully ready
            setTimeout(function() {
                if (typeof window.loadEventStats === 'function') {
                    window.loadEventStats(0);
                }
            }, 300);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLoadEventStats);
        } else {
            initLoadEventStats();
        }

        // Also refresh stats periodically (every 30 seconds)
        setInterval(function() {
            if (typeof window.loadEventStats === 'function') {
                window.loadEventStats(0);
            }
        }, 30000); // Refresh every 30 seconds
    </script>

    <!-- Event Attendees Modals (Global - outside fragment to prevent recreation on reload) -->
    <!-- Add Attendee Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-person-plus me-2"></i>Th√™m Ng∆∞·ªùi Tham D·ª±
                    </h5>
                    <button type="button" class="btn-close btn-close-white" onclick="closeAddModal()"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="addForm" onsubmit="event.preventDefault(); return false;">
                        <div class="mb-3">
                            <label for="addName" class="form-label fw-bold">T√™n <span class="text-danger">*</span></label>
                            <input type="text" id="addName" class="form-control form-control-lg" placeholder="Nh·∫≠p t√™n" required>
                        </div>

                        <div class="mb-3">
                            <label for="addEmail" class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                            <input type="email" id="addEmail" class="form-control form-control-lg" placeholder="example@email.com" required>
                        </div>

                        <div class="mb-3">
                            <label for="addPhone" class="form-label fw-bold">S·ªë ƒêi·ªán Tho·∫°i <span class="text-danger">*</span></label>
                            <input type="tel" id="addPhone" class="form-control form-control-lg" placeholder="0912345678" required>
                        </div>

                        <div class="mb-3">
                            <label for="addOrganization" class="form-label fw-bold">T·ªï Ch·ª©c</label>
                            <input type="text" id="addOrganization" class="form-control form-control-lg" placeholder="Nh·∫≠p t·ªï ch·ª©c (n·∫øu c√≥)">
                        </div>

                        <div class="mb-3">
                            <label for="addTicketType" class="form-label fw-bold">Lo·∫°i V√© <span class="text-danger">*</span></label>
                            <select id="addTicketType" class="form-select form-select-lg" required>
                                <option value="">-- Ch·ªçn lo·∫°i v√© --</option>
                                <!-- Options will be loaded via JavaScript -->
                            </select>
                        </div>
                    </form>
                </div>

                <div class="modal-footer border-0 p-4 bg-light">
                    <button type="button" class="btn btn-secondary btn-lg fw-bold" onclick="closeAddModal()">
                        <i class="bi bi-x-lg me-1"></i>H·ªßy
                    </button>
                    <button type="button" class="btn btn-success btn-lg fw-bold" onclick="submitAddAttendee()">
                        <i class="bi bi-plus-lg me-1"></i>Th√™m
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Attendee Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-pencil-square me-2"></i>Ch·ªânh S·ª≠a Ng∆∞·ªùi Tham D·ª±
                    </h5>
                    <button type="button" class="btn-close btn-close-white" onclick="closeEditModal()"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="editForm" onsubmit="event.preventDefault(); return false;">
                        <input type="hidden" id="editAttendanceId">

                        <div class="mb-3">
                            <label for="editName" class="form-label fw-bold">T√™n <span class="text-danger">*</span></label>
                            <input type="text" id="editName" class="form-control form-control-lg" placeholder="Nh·∫≠p t√™n" required>
                        </div>

                        <div class="mb-3">
                            <label for="editEmail" class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                            <input type="email" id="editEmail" class="form-control form-control-lg" placeholder="example@email.com" required>
                        </div>

                        <div class="mb-3">
                            <label for="editPhone" class="form-label fw-bold">S·ªë ƒêi·ªán Tho·∫°i <span class="text-danger">*</span></label>
                            <input type="tel" id="editPhone" class="form-control form-control-lg" placeholder="0912345678" required>
                        </div>

                        <div class="mb-3">
                            <label for="editOrganization" class="form-label fw-bold">T·ªï Ch·ª©c</label>
                            <input type="text" id="editOrganization" class="form-control form-control-lg" placeholder="Nh·∫≠p t·ªï ch·ª©c (n·∫øu c√≥)">
                        </div>
                    </form>
                </div>

                <div class="modal-footer border-0 p-4 bg-light">
                    <button type="button" class="btn btn-secondary btn-lg fw-bold" onclick="closeEditModal()">
                        <i class="bi bi-x-lg me-1"></i>H·ªßy
                    </button>
                    <button type="button" class="btn btn-primary btn-lg fw-bold" onclick="submitEditAttendee()">
                        <i class="bi bi-check-lg me-1"></i>L∆∞u
                    </button>
                </div>
            </div>
        </div>
    </div>
    </body>

    </html>