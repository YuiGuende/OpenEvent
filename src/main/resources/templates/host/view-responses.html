<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Responses</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .response-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .response-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .form-type-section {
            margin-bottom: 40px;
        }
        .form-type-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .form-type-header.register {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .form-type-header.checkin {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .form-type-header.feedback {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .export-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="response-container">
            <div class="response-header">
                <h2><i class="fas fa-chart-bar"></i> Form Responses</h2>
                <p>View and analyze responses from event participants</p>
            </div>
            
            <!-- Export Button -->
            <div class="text-center mb-4">
                <button class="btn export-btn btn-lg" onclick="exportAllToCSV()">
                    <i class="fas fa-download"></i> Export All to CSV
                </button>
                <a th:href="@{'/music/' + ${eventId}}" class="btn btn-secondary btn-lg ms-2">
                    <i class="fas fa-arrow-left"></i> Back to Event
                </a>
            </div>

            <!-- Register Form Responses -->
            <div class="form-type-section">
                <div class="form-type-header register">
                    <h3><i class="fas fa-user-plus"></i> Register Form Responses</h3>
                    <p>Total: <span th:text="${#lists.size(registerResponses)}">0</span> responses</p>
                </div>
                
                <div th:if="${#lists.isEmpty(registerResponses)}" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h4>No register responses yet</h4>
                    <p>Participants haven't submitted register forms for this event.</p>
                </div>
                
                <div th:if="${!#lists.isEmpty(registerResponses)}" class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th><i class="fas fa-user"></i> Customer Name</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-question-circle"></i> Question</th>
                                <th><i class="fas fa-comment"></i> Response</th>
                                <th><i class="fas fa-clock"></i> Submitted At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="response, iterStat : ${registerResponses}">
                                <td th:text="${iterStat.index + 1}">1</td>
                                <td>
                                    <strong th:text="${response.customerName ?: 'N/A'}">Customer Name</strong>
                                </td>
                                <td>
                                    <span th:text="${response.customerEmail ?: 'N/A'}">email@example.com</span>
                                </td>
                                <td>
                                    <span th:text="${response.questionText ?: 'N/A'}">Question text</span>
                                </td>
                                <td>
                                    <span th:text="${response.responseValue}">Response value</span>
                                </td>
                                <td>
                                    <small class="text-muted" 
                                           th:text="${response.submittedAt != null ? #temporals.format(response.submittedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">
                                        01/01/2024 12:00
                                    </small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Check-in Form Responses -->
            <div class="form-type-section">
                <div class="form-type-header checkin">
                    <h3><i class="fas fa-sign-in-alt"></i> Check-in Form Responses</h3>
                    <p>Total: <span th:text="${#lists.size(checkinResponses)}">0</span> responses</p>
                </div>
                
                <div th:if="${#lists.isEmpty(checkinResponses)}" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h4>No check-in responses yet</h4>
                    <p>Participants haven't submitted check-in forms for this event.</p>
                </div>
                
                <div th:if="${!#lists.isEmpty(checkinResponses)}" class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th><i class="fas fa-user"></i> Customer Name</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-question-circle"></i> Question</th>
                                <th><i class="fas fa-comment"></i> Response</th>
                                <th><i class="fas fa-clock"></i> Submitted At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="response, iterStat : ${checkinResponses}">
                                <td th:text="${iterStat.index + 1}">1</td>
                                <td>
                                    <strong th:text="${response.customerName ?: 'N/A'}">Customer Name</strong>
                                </td>
                                <td>
                                    <span th:text="${response.customerEmail ?: 'N/A'}">email@example.com</span>
                                </td>
                                <td>
                                    <span th:text="${response.questionText ?: 'N/A'}">Question text</span>
                                </td>
                                <td>
                                    <span th:text="${response.responseValue}">Response value</span>
                                </td>
                                <td>
                                    <small class="text-muted" 
                                           th:text="${response.submittedAt != null ? #temporals.format(response.submittedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">
                                        01/01/2024 12:00
                                    </small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Feedback Form Responses -->
            <div class="form-type-section">
                <div class="form-type-header feedback">
                    <h3><i class="fas fa-comment-dots"></i> Feedback Form Responses</h3>
                    <p>Total: <span th:text="${#lists.size(feedbackResponses)}">0</span> responses</p>
                </div>
                
                <div th:if="${#lists.isEmpty(feedbackResponses)}" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h4>No feedback responses yet</h4>
                    <p>Participants haven't submitted feedback forms for this event.</p>
                </div>
                
                <div th:if="${!#lists.isEmpty(feedbackResponses)}" class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th><i class="fas fa-user"></i> Customer Name</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-question-circle"></i> Question</th>
                                <th><i class="fas fa-comment"></i> Response</th>
                                <th><i class="fas fa-clock"></i> Submitted At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="response, iterStat : ${feedbackResponses}">
                                <td th:text="${iterStat.index + 1}">1</td>
                                <td>
                                    <strong th:text="${response.customerName ?: 'N/A'}">Customer Name</strong>
                                </td>
                                <td>
                                    <span th:text="${response.customerEmail ?: 'N/A'}">email@example.com</span>
                                </td>
                                <td>
                                    <span th:text="${response.questionText ?: 'N/A'}">Question text</span>
                                </td>
                                <td>
                                    <span th:text="${response.responseValue}">Response value</span>
                                </td>
                                <td>
                                    <small class="text-muted" 
                                           th:text="${response.submittedAt != null ? #temporals.format(response.submittedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">
                                        01/01/2024 12:00
                                    </small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function exportAllToCSV() {
            const allData = [];
            
            // Get data from all three tables
            const tables = document.querySelectorAll('.table-responsive table');
            tables.forEach((table, tableIndex) => {
                const tableTitle = table.closest('.form-type-section').querySelector('.form-type-header h3').textContent.trim();
                
                // Get headers
                const headers = [];
                table.querySelectorAll('thead th').forEach((th, index) => {
                    if (index > 0) { // Skip # column
                        headers.push(th.textContent.trim().replace(/\s+/g, ' '));
                    }
                });
                
                // Get data rows
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const row = {
                        'Form Type': tableTitle,
                        cells: []
                    };
                    tr.querySelectorAll('td').forEach((td, index) => {
                        if (index > 0) { // Skip # column
                            row.cells.push(td.textContent.trim().replace(/\s+/g, ' '));
                        }
                    });
                    allData.push(row);
                });
            });
            
            if (allData.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Prepare CSV with Form Type column
            const csvHeaders = ['Form Type', ...headers];
            const csvRows = [];
            
            allData.forEach(row => {
                const csvRow = [`"${row['Form Type'].replace(/"/g, '""')}"`, ...row.cells.map(cell => `"${cell.replace(/"/g, '""')}"`)];
                csvRows.push(csvRow.join(','));
            });
            
            // Convert to CSV with UTF-8 BOM for Excel compatibility
            const BOM = '\uFEFF';
            const csvContent = BOM + csvHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n' + csvRows.join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `form_responses_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
