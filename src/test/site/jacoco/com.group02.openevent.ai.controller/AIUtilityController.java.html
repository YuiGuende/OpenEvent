<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AIUtilityController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenEvent</a> &gt; <a href="index.source.html" class="el_package">com.group02.openevent.ai.controller</a> &gt; <span class="el_source">AIUtilityController.java</span></div><h1>AIUtilityController.java</h1><pre class="source lang-java linenums">package com.group02.openevent.ai.controller;

import com.group02.openevent.ai.service.EmbeddingService;
import com.group02.openevent.ai.service.WeatherService;
import com.group02.openevent.ai.qdrant.service.QdrantService;
import com.group02.openevent.ai.qdrant.service.VectorIntentClassifier;
import com.group02.openevent.ai.qdrant.model.ActionType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Controller để xử lý các utility functions của AI
 * @author Admin
 */
@RestController
@RequestMapping(&quot;/api/ai/utility&quot;)
@CrossOrigin(origins = &quot;*&quot;)
public class AIUtilityController {

    private final EmbeddingService embeddingService;
    private final WeatherService weatherService;
    private final QdrantService qdrantService;
    private final VectorIntentClassifier intentClassifier;

    public AIUtilityController(EmbeddingService embeddingService,
                               WeatherService weatherService,
                               QdrantService qdrantService,
<span class="fc" id="L34">                               VectorIntentClassifier intentClassifier) {</span>
<span class="fc" id="L35">        this.embeddingService = embeddingService;</span>
<span class="fc" id="L36">        this.weatherService = weatherService;</span>
<span class="fc" id="L37">        this.qdrantService = qdrantService;</span>
<span class="fc" id="L38">        this.intentClassifier = intentClassifier;</span>
<span class="fc" id="L39">    }</span>

    /**
     * Tạo embedding cho text
     *
     * @param request Map chứa text
     * @return ResponseEntity chứa embedding vector
     */
    @PostMapping(&quot;/embedding&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; generateEmbedding(@RequestBody Map&lt;String, String&gt; request) {
        try {
<span class="fc" id="L50">            String text = request.get(&quot;text&quot;);</span>

<span class="pc bpc" id="L52" title="1 of 4 branches missed.">            if (text == null || text.trim().isEmpty()) {</span>
<span class="fc" id="L53">                return ResponseEntity.badRequest()</span>
<span class="fc" id="L54">                        .body(Map.of(&quot;error&quot;, &quot;❌ Text không được để trống&quot;));</span>
            }

<span class="fc" id="L57">            float[] embedding = embeddingService.getEmbedding(text);</span>

<span class="fc" id="L59">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="fc" id="L60">                    &quot;success&quot;, true,</span>
                    &quot;text&quot;, text,
<span class="fc" id="L62">                    &quot;embeddingSize&quot;, embedding.length,</span>
                    &quot;embedding&quot;, embedding
            );

<span class="fc" id="L66">            return ResponseEntity.ok(result);</span>

<span class="nc" id="L68">        } catch (Exception e) {</span>
<span class="nc" id="L69">            e.printStackTrace();</span>
<span class="nc" id="L70">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="nc" id="L71">                    &quot;success&quot;, false,</span>
<span class="nc" id="L72">                    &quot;error&quot;, &quot;❌ Lỗi khi tạo embedding: &quot; + e.getMessage()</span>
            );
<span class="nc" id="L74">            return ResponseEntity.internalServerError().body(result);</span>
        }
    }

    /**
     * Tính cosine similarity giữa hai text
     *
     * @param request Map chứa hai text
     * @return ResponseEntity chứa similarity score
     */
    @PostMapping(&quot;/similarity&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; calculateSimilarity(@RequestBody Map&lt;String, String&gt; request) {
        try {
<span class="fc" id="L87">            String text1 = request.get(&quot;text1&quot;);</span>
<span class="fc" id="L88">            String text2 = request.get(&quot;text2&quot;);</span>

<span class="pc bpc" id="L90" title="3 of 8 branches missed.">            if (text1 == null || text2 == null || text1.trim().isEmpty() || text2.trim().isEmpty()) {</span>
<span class="fc" id="L91">                return ResponseEntity.badRequest()</span>
<span class="fc" id="L92">                        .body(Map.of(&quot;error&quot;, &quot;❌ Cả hai text không được để trống&quot;));</span>
            }

<span class="fc" id="L95">            float[] embedding1 = embeddingService.getEmbedding(text1);</span>
<span class="fc" id="L96">            float[] embedding2 = embeddingService.getEmbedding(text2);</span>

<span class="fc" id="L98">            double similarity = embeddingService.cosineSimilarity(embedding1, embedding2);</span>

<span class="fc" id="L100">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="fc" id="L101">                    &quot;success&quot;, true,</span>
                    &quot;text1&quot;, text1,
                    &quot;text2&quot;, text2,
<span class="fc" id="L104">                    &quot;similarity&quot;, similarity,</span>
<span class="fc" id="L105">                    &quot;similarityPercentage&quot;, String.format(&quot;%.2f%%&quot;, similarity * 100)</span>
            );

<span class="fc" id="L108">            return ResponseEntity.ok(result);</span>

<span class="nc" id="L110">        } catch (Exception e) {</span>
<span class="nc" id="L111">            e.printStackTrace();</span>
<span class="nc" id="L112">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="nc" id="L113">                    &quot;success&quot;, false,</span>
<span class="nc" id="L114">                    &quot;error&quot;, &quot;❌ Lỗi khi tính similarity: &quot; + e.getMessage()</span>
            );
<span class="nc" id="L116">            return ResponseEntity.internalServerError().body(result);</span>
        }
    }

    /**
     * Phân loại intent của text
     *
     * @param request Map chứa text
     * @return ResponseEntity chứa intent classification
     */
    @PostMapping(&quot;/classify-intent&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; classifyIntent(@RequestBody Map&lt;String, String&gt; request) {
        try {
<span class="fc" id="L129">            String text = request.get(&quot;text&quot;);</span>

<span class="pc bpc" id="L131" title="1 of 4 branches missed.">            if (text == null || text.trim().isEmpty()) {</span>
<span class="fc" id="L132">                return ResponseEntity.badRequest()</span>
<span class="fc" id="L133">                        .body(Map.of(&quot;error&quot;, &quot;❌ Text không được để trống&quot;));</span>
            }
<span class="fc" id="L135">            float[] textVector = embeddingService.getEmbedding(text);</span>
<span class="fc" id="L136">            ActionType intent = intentClassifier.classifyIntent(text, textVector);</span>
<span class="fc" id="L137">            String weatherIntent = intentClassifier.classifyWeather(text, textVector);</span>
<span class="fc" id="L138">            String toolIntent = intentClassifier.classifyToolEvent(text,  textVector);</span>

<span class="fc" id="L140">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="fc" id="L141">                    &quot;success&quot;, true,</span>
                    &quot;text&quot;, text,
<span class="fc" id="L143">                    &quot;actionType&quot;, intent.toString(),</span>
                    &quot;weatherIntent&quot;, weatherIntent,
                    &quot;toolIntent&quot;, toolIntent
            );

<span class="fc" id="L148">            return ResponseEntity.ok(result);</span>

<span class="nc" id="L150">        } catch (Exception e) {</span>
<span class="nc" id="L151">            e.printStackTrace();</span>
<span class="nc" id="L152">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="nc" id="L153">                    &quot;success&quot;, false,</span>
<span class="nc" id="L154">                    &quot;error&quot;, &quot;❌ Lỗi khi phân loại intent: &quot; + e.getMessage()</span>
            );
<span class="nc" id="L156">            return ResponseEntity.internalServerError().body(result);</span>
        }
    }

    /**
     * Lấy thông tin thời tiết
     *
     * @param request Map chứa thông tin địa điểm và thời gian
     * @return ResponseEntity chứa thông tin thời tiết
     */
    @PostMapping(&quot;/weather&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getWeather(@RequestBody Map&lt;String, Object&gt; request) {
        try {
<span class="fc" id="L169">            String location = (String) request.getOrDefault(&quot;location&quot;, &quot;Da Nang&quot;);</span>
<span class="fc" id="L170">            String dateStr = (String) request.getOrDefault(&quot;date&quot;, LocalDateTime.now().toString());</span>

<span class="fc" id="L172">            LocalDateTime date = LocalDateTime.parse(dateStr);</span>
<span class="fc" id="L173">            String forecast = weatherService.getForecastNote(date, location);</span>

<span class="fc" id="L175">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="fc" id="L176">                    &quot;success&quot;, true,</span>
                    &quot;location&quot;, location,
                    &quot;date&quot;, dateStr,
<span class="pc bpc" id="L179" title="2 of 4 branches missed.">                    &quot;forecast&quot;, forecast != null ? forecast : &quot;Không có dự báo thời tiết&quot;,</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">                    &quot;hasWeatherWarning&quot;, forecast != null &amp;&amp; !forecast.isEmpty()</span>
            );

<span class="fc" id="L183">            return ResponseEntity.ok(result);</span>

<span class="fc" id="L185">        } catch (Exception e) {</span>
<span class="fc" id="L186">            e.printStackTrace();</span>
<span class="fc" id="L187">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="fc" id="L188">                    &quot;success&quot;, false,</span>
<span class="fc" id="L189">                    &quot;error&quot;, &quot;❌ Lỗi khi lấy thông tin thời tiết: &quot; + e.getMessage()</span>
            );
<span class="fc" id="L191">            return ResponseEntity.internalServerError().body(result);</span>
        }
    }

    /**
     * Tìm kiếm vector tương tự trong Qdrant
     *
     * @param request Map chứa query text
     * @return ResponseEntity chứa kết quả tìm kiếm
     */
    @PostMapping(&quot;/vector-search&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; vectorSearch(@RequestBody Map&lt;String, Object&gt; request) {
        try {
<span class="fc" id="L204">            String queryText = (String) request.get(&quot;query&quot;);</span>
<span class="fc" id="L205">            Integer topK = (Integer) request.getOrDefault(&quot;topK&quot;, 5);</span>

<span class="pc bpc" id="L207" title="1 of 4 branches missed.">            if (queryText == null || queryText.trim().isEmpty()) {</span>
<span class="fc" id="L208">                return ResponseEntity.badRequest()</span>
<span class="fc" id="L209">                        .body(Map.of(&quot;error&quot;, &quot;❌ Query text không được để trống&quot;));</span>
            }

<span class="fc" id="L212">            float[] queryVector = embeddingService.getEmbedding(queryText);</span>
<span class="fc" id="L213">            List&lt;Map&lt;String, Object&gt;&gt; results = qdrantService.searchSimilarVectors(queryVector, topK);</span>

<span class="fc" id="L215">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="fc" id="L216">                    &quot;success&quot;, true,</span>
                    &quot;query&quot;, queryText,
                    &quot;topK&quot;, topK,
                    &quot;results&quot;, results,
<span class="fc" id="L220">                    &quot;resultCount&quot;, results.size()</span>
            );

<span class="fc" id="L223">            return ResponseEntity.ok(result);</span>

<span class="nc" id="L225">        } catch (Exception e) {</span>
<span class="nc" id="L226">            e.printStackTrace();</span>
<span class="nc" id="L227">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="nc" id="L228">                    &quot;success&quot;, false,</span>
<span class="nc" id="L229">                    &quot;error&quot;, &quot;❌ Lỗi khi tìm kiếm vector: &quot; + e.getMessage()</span>
            );
<span class="nc" id="L231">            return ResponseEntity.internalServerError().body(result);</span>
        }
    }

    /**
     * Upload vector vào Qdrant
     *
     * @param request Map chứa thông tin vector
     * @return ResponseEntity chứa kết quả upload
     */
    @PostMapping(&quot;/upload-vector&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; uploadVector(@RequestBody Map&lt;String, Object&gt; request) {
        try {
<span class="fc" id="L244">            String id = (String) request.get(&quot;id&quot;);</span>
<span class="fc" id="L245">            String text = (String) request.get(&quot;text&quot;);</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L247">            Map&lt;String, Object&gt; payload = (Map&lt;String, Object&gt;) request.get(&quot;payload&quot;);</span>

<span class="pc bpc" id="L249" title="2 of 6 branches missed.">            if (id == null || text == null || payload == null) {</span>
<span class="fc" id="L250">                return ResponseEntity.badRequest()</span>
<span class="fc" id="L251">                        .body(Map.of(&quot;error&quot;, &quot;❌ Thiếu thông tin id, text hoặc payload&quot;));</span>
            }

<span class="fc" id="L254">            float[] embedding = embeddingService.getEmbedding(text);</span>
<span class="fc" id="L255">            String result = qdrantService.upsertEmbedding(id, embedding, payload);</span>

<span class="fc" id="L257">            Map&lt;String, Object&gt; response = Map.of(</span>
<span class="fc" id="L258">                    &quot;success&quot;, true,</span>
                    &quot;id&quot;, id,
                    &quot;text&quot;, text,
                    &quot;result&quot;, result
            );

<span class="fc" id="L264">            return ResponseEntity.ok(response);</span>

<span class="nc" id="L266">        } catch (Exception e) {</span>
<span class="nc" id="L267">            e.printStackTrace();</span>
<span class="nc" id="L268">            Map&lt;String, Object&gt; result = Map.of(</span>
<span class="nc" id="L269">                    &quot;success&quot;, false,</span>
<span class="nc" id="L270">                    &quot;error&quot;, &quot;❌ Lỗi khi upload vector: &quot; + e.getMessage()</span>
            );
<span class="nc" id="L272">            return ResponseEntity.internalServerError().body(result);</span>
        }
    }

    /**
     * Kiểm tra health của các AI services
     *
     * @return ResponseEntity chứa trạng thái health
     */
    @GetMapping(&quot;/health&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; checkHealth() {
<span class="fc" id="L283">        Map&lt;String, Object&gt; health = new HashMap&lt;&gt;();</span>
<span class="fc" id="L284">        float[] testVector = null;</span>
        try {
            // Kiểm tra EmbeddingService
            try {
                // Lấy vector và lưu lại để dùng cho Qdrant
<span class="fc" id="L289">                testVector = embeddingService.getEmbedding(&quot;test health check&quot;);</span>
<span class="fc" id="L290">                int vectorSize = testVector.length;</span>
<span class="fc" id="L291">                health.put(&quot;embeddingService&quot;, Map.of(&quot;status&quot;, &quot;UP&quot;, &quot;vectorSize&quot;, vectorSize));</span>
<span class="fc" id="L292">            } catch (Exception e) {</span>
<span class="fc" id="L293">                health.put(&quot;embeddingService&quot;, Map.of(&quot;status&quot;, &quot;DOWN&quot;, &quot;error&quot;, e.getMessage()));</span>
<span class="fc" id="L294">            }</span>

            // Kiểm tra WeatherService
            try {
<span class="fc" id="L298">                String testWeather = weatherService.getForecastNote(LocalDateTime.now(), &quot;Da Nang&quot;);</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">                health.put(&quot;weatherService&quot;, Map.of(&quot;status&quot;, &quot;UP&quot;, &quot;testResult&quot;, testWeather != null));</span>
<span class="nc" id="L300">            } catch (Exception e) {</span>
<span class="nc" id="L301">                health.put(&quot;weatherService&quot;, Map.of(&quot;status&quot;, &quot;DOWN&quot;, &quot;error&quot;, e.getMessage()));</span>
<span class="fc" id="L302">            }</span>

            // Kiểm tra VectorIntentClassifier
            try {
<span class="fc" id="L306">                ActionType testIntent = intentClassifier.classifyIntent(&quot;test&quot;, testVector);</span>
<span class="fc" id="L307">                health.put(&quot;intentClassifier&quot;, Map.of(&quot;status&quot;, &quot;UP&quot;, &quot;testIntent&quot;, testIntent.toString()));</span>
<span class="fc" id="L308">            } catch (Exception e) {</span>
<span class="fc" id="L309">                health.put(&quot;intentClassifier&quot;, Map.of(&quot;status&quot;, &quot;DOWN&quot;, &quot;error&quot;, e.getMessage()));</span>
<span class="fc" id="L310">            }</span>

<span class="pc bpc" id="L312" title="1 of 4 branches missed.">            if (testVector != null &amp;&amp; testVector.length &gt; 1) {</span>
                try {
                    // Sử dụng testVector đã tạo thành công ở bước 1
<span class="fc" id="L315">                    List&lt;Map&lt;String, Object&gt;&gt; testSearch = qdrantService.searchSimilarVectors(testVector, 1);</span>
<span class="fc" id="L316">                    health.put(&quot;qdrantService&quot;, Map.of(&quot;status&quot;, &quot;UP&quot;, &quot;searchResult&quot;, testSearch.size()));</span>
<span class="nc" id="L317">                } catch (Exception e) {</span>
<span class="nc" id="L318">                    health.put(&quot;qdrantService&quot;, Map.of(&quot;status&quot;, &quot;DOWN&quot;, &quot;error&quot;, &quot;Qdrant error: &quot; + e.getMessage()));</span>
<span class="pc" id="L319">                }</span>
            } else {
                // Chỉ định rõ nếu Qdrant không thể test do Embedding lỗi
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">                if (&quot;DOWN&quot;.equals(((Map&lt;String, Object&gt;)health.get(&quot;embeddingService&quot;)).get(&quot;status&quot;))) {</span>
<span class="fc" id="L323">                    health.put(&quot;qdrantService&quot;, Map.of(&quot;status&quot;, &quot;DOWN&quot;, &quot;error&quot;, &quot;Cannot test Qdrant: EmbeddingService is DOWN.&quot;));</span>
                } else {
                    // Trường hợp này rất hiếm, nhưng để đảm bảo logic
<span class="nc" id="L326">                    health.put(&quot;qdrantService&quot;, Map.of(&quot;status&quot;, &quot;DOWN&quot;, &quot;error&quot;, &quot;Cannot test Qdrant: testVector has size &lt;= 1.&quot;));</span>
                }
            }

<span class="fc" id="L330">            boolean allUp = health.values().stream()</span>
<span class="fc" id="L331">                    .filter(v -&gt; v instanceof Map) // Chỉ xử lý các giá trị là Map</span>
<span class="fc" id="L332">                    .allMatch(v -&gt; &quot;UP&quot;.equals(((Map&lt;?, ?&gt;) v).get(&quot;status&quot;)));</span>

<span class="fc" id="L334">            health.put(&quot;timestamp&quot;, LocalDateTime.now().toString());</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">            health.put(&quot;overall&quot;, allUp ? &quot;UP&quot; : &quot;DOWN&quot;);</span>

<span class="fc" id="L337">            return ResponseEntity.ok(health);</span>

<span class="nc" id="L339">        } catch (Exception e) {</span>
            // Lỗi xảy ra bên ngoài các block try/catch con (ít xảy ra)
<span class="nc" id="L341">            e.printStackTrace();</span>
<span class="nc" id="L342">            Map&lt;String, Object&gt; errorHealth = Map.of(</span>
                    &quot;overall&quot;, &quot;DOWN&quot;,
<span class="nc" id="L344">                    &quot;error&quot;, &quot;Internal error during health check: &quot; + e.getMessage(),</span>
<span class="nc" id="L345">                    &quot;timestamp&quot;, LocalDateTime.now().toString()</span>
            );
<span class="nc" id="L347">            return ResponseEntity.internalServerError().body(errorHealth);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>