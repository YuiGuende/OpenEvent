<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderAIService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenEvent</a> &gt; <a href="index.source.html" class="el_package">com.group02.openevent.ai.service</a> &gt; <span class="el_source">OrderAIService.java</span></div><h1>OrderAIService.java</h1><pre class="source lang-java linenums">package com.group02.openevent.ai.service;

import com.group02.openevent.ai.dto.PendingOrder;
import com.group02.openevent.dto.order.CreateOrderWithTicketTypeRequest;
import com.group02.openevent.model.event.Event;
import com.group02.openevent.model.order.Order;
import com.group02.openevent.model.payment.Payment;
import com.group02.openevent.model.ticket.TicketType;
import com.group02.openevent.model.user.Customer;
import com.group02.openevent.repository.IUserRepo;
import com.group02.openevent.service.EventService;
import com.group02.openevent.service.OrderService;
import com.group02.openevent.service.PaymentService;
import com.group02.openevent.service.TicketTypeService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

/**
 * Service to handle AI-driven order creation
 */
@Service
<span class="fc" id="L29">@RequiredArgsConstructor</span>
<span class="fc" id="L30">@Slf4j</span>
public class OrderAIService {

    private final EventService eventService;
    private final TicketTypeService ticketTypeService;
    private final OrderService orderService;
    private final PaymentService paymentService;
    private final IUserRepo userRepo;
    private final AgentEventService  agentEventService;

    // Store pending orders by userId
<span class="fc" id="L41">    private final Map&lt;Long, PendingOrder&gt; pendingOrders = new HashMap&lt;&gt;();</span>

    /**
     * Start order creation process
     */
    public String startOrderCreation(Long userId, String eventQuery) {
        // Search for event (PUBLIC status only for ticket buying)
<span class="nc" id="L48">        List&lt;Event&gt; events = eventService.findByTitleAndPublicStatus(eventQuery);</span>

<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (events.isEmpty()) {</span>
<span class="nc" id="L51">            return &quot;‚ùå Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán \&quot;&quot; + eventQuery + &quot;\&quot;. Vui l√≤ng ki·ªÉm tra l·∫°i t√™n s·ª± ki·ªán.&quot;;</span>
        }

<span class="nc" id="L54">        Event event = events.get(0);</span>

        // Create pending order
<span class="nc" id="L57">        PendingOrder pendingOrder = new PendingOrder();</span>
<span class="nc" id="L58">        pendingOrder.setEvent(event);</span>
<span class="nc" id="L59">        pendingOrder.setCurrentStep(PendingOrder.OrderStep.SELECT_TICKET_TYPE);</span>
<span class="nc" id="L60">        pendingOrders.put(userId, pendingOrder);</span>

        // Get available ticket types
<span class="nc" id="L63">        List&lt;TicketType&gt; ticketTypes = ticketTypeService.getTicketTypesByEventId(event.getId());</span>

<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (ticketTypes.isEmpty()) {</span>
<span class="nc" id="L66">            return &quot;‚ùå S·ª± ki·ªán \&quot;&quot; + event.getTitle() + &quot;\&quot; hi·ªán kh√¥ng c√≥ v√© n√†o.&quot;;</span>
        }

<span class="nc" id="L69">        StringBuilder response = new StringBuilder();</span>
<span class="nc" id="L70">        response.append(&quot;üé´ S·ª± ki·ªán: **&quot;).append(event.getTitle()).append(&quot;**\n\n&quot;);</span>
<span class="nc" id="L71">        response.append(&quot;üìÖ Th·ªùi gian: &quot;).append(event.getStartsAt()).append(&quot;\n\n&quot;);</span>
<span class="nc" id="L72">        response.append(&quot;C√°c lo·∫°i v√© c√≥ s·∫µn:\n\n&quot;);</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">        for (TicketType ticket : ticketTypes) {</span>
<span class="nc" id="L75">            response.append(&quot;‚Ä¢ **&quot;).append(ticket.getName()).append(&quot;**\n&quot;);</span>
<span class="nc" id="L76">            response.append(&quot;  - Gi√°: &quot;).append(ticket.getFinalPrice()).append(&quot; VND\n&quot;);</span>
<span class="nc" id="L77">            response.append(&quot;  - C√≤n l·∫°i: &quot;).append(ticket.getAvailableQuantity()).append(&quot; v√©\n&quot;);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (ticket.getDescription() != null) {</span>
<span class="nc" id="L79">                response.append(&quot;  - M√¥ t·∫£: &quot;).append(ticket.getDescription()).append(&quot;\n&quot;);</span>
            }
<span class="nc" id="L81">            response.append(&quot;\n&quot;);</span>
<span class="nc" id="L82">        }</span>

<span class="nc" id="L84">        response.append(&quot;üí° B·∫°n mu·ªën ch·ªçn lo·∫°i v√© n√†o?&quot;);</span>

<span class="nc" id="L86">        return response.toString();</span>
    }

    /**
     * Select ticket type
     */
    public String selectTicketType(Long userId, String ticketTypeName) {
<span class="nc" id="L93">        PendingOrder pendingOrder = pendingOrders.get(userId);</span>

<span class="nc bnc" id="L95" title="All 4 branches missed.">        if (pendingOrder == null || pendingOrder.getEvent() == null) {</span>
<span class="nc" id="L96">            return &quot;‚ùå Vui l√≤ng ch·ªçn s·ª± ki·ªán tr∆∞·ªõc. B·∫°n c√≥ th·ªÉ n√≥i: 'Mua v√© s·ª± ki·ªán [t√™n s·ª± ki·ªán]'&quot;;</span>
        }

        // Find ticket type
<span class="nc" id="L100">        List&lt;TicketType&gt; ticketTypes = ticketTypeService.getTicketTypesByEventId(pendingOrder.getEvent().getId());</span>
<span class="nc" id="L101">        Optional&lt;TicketType&gt; selectedTicket = ticketTypes.stream()</span>
<span class="nc" id="L102">                .filter(t -&gt; t.getName().toLowerCase().contains(ticketTypeName.toLowerCase()))</span>
<span class="nc" id="L103">                .findFirst();</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (selectedTicket.isEmpty()) {</span>
<span class="nc" id="L106">            return &quot;‚ùå Kh√¥ng t√¨m th·∫•y lo·∫°i v√© \&quot;&quot; + ticketTypeName + &quot;\&quot;. C√°c lo·∫°i v√© c√≥ s·∫µn: &quot;</span>
<span class="nc" id="L107">                    + String.join(&quot;, &quot;, ticketTypes.stream().map(TicketType::getName).toList());</span>
        }

<span class="nc" id="L110">        TicketType ticket = selectedTicket.get();</span>

        // Check availability
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!ticket.isAvailable()) {</span>
<span class="nc" id="L114">            return &quot;‚ùå Lo·∫°i v√© \&quot;&quot; + ticket.getName() + &quot;\&quot; ƒë√£ h·∫øt. Vui l√≤ng ch·ªçn lo·∫°i v√© kh√°c.&quot;;</span>
        }

<span class="nc" id="L117">        pendingOrder.setTicketType(ticket);</span>
<span class="nc" id="L118">        pendingOrder.setCurrentStep(PendingOrder.OrderStep.PROVIDE_INFO);</span>

<span class="nc" id="L120">        return &quot;‚úÖ ƒê√£ ch·ªçn v√© **&quot; + ticket.getName() + &quot;** - Gi√°: &quot; + ticket.getFinalPrice() + &quot; VND\n\n&quot; +</span>
               &quot;üìù Vui l√≤ng cung c·∫•p th√¥ng tin:\n&quot; +
               &quot;- T√™n ng∆∞·ªùi tham gia\n&quot; +
               &quot;- Email\n&quot; +
               &quot;- S·ªë ƒëi·ªán tho·∫°i (t√πy ch·ªçn)\n\n&quot; +
               &quot;V√≠ d·ª•: 'T√™n: Nguy·ªÖn VƒÉn A, Email: test@gmail.com, SƒêT: 0123456789'&quot;;
    }

    /**
     * Provide participant information
     */
    public String provideInfo(Long userId, Map&lt;String, String&gt; info) {
<span class="nc" id="L132">        PendingOrder pendingOrder = pendingOrders.get(userId);</span>

<span class="nc bnc" id="L134" title="All 4 branches missed.">        if (pendingOrder == null || pendingOrder.getTicketType() == null) {</span>
<span class="nc" id="L135">            return &quot;‚ùå Vui l√≤ng ch·ªçn lo·∫°i v√© tr∆∞·ªõc.&quot;;</span>
        }

        // Extract information
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (info.containsKey(&quot;name&quot;)) pendingOrder.setParticipantName(info.get(&quot;name&quot;));</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (info.containsKey(&quot;email&quot;)) pendingOrder.setParticipantEmail(info.get(&quot;email&quot;));</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (info.containsKey(&quot;phone&quot;)) pendingOrder.setParticipantPhone(info.get(&quot;phone&quot;));</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (info.containsKey(&quot;organization&quot;)) pendingOrder.setParticipantOrganization(info.get(&quot;organization&quot;));</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (info.containsKey(&quot;notes&quot;)) pendingOrder.setNotes(info.get(&quot;notes&quot;));</span>

        // Check if complete
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!pendingOrder.isComplete()) {</span>
<span class="nc" id="L147">            return &quot;‚ö†Ô∏è C√≤n thi·∫øu th√¥ng tin:\n&quot; + pendingOrder.getMissingFields() +</span>
                   &quot;\nVui l√≤ng cung c·∫•p ƒë·∫ßy ƒë·ªß th√¥ng tin.&quot;;
        }

<span class="nc" id="L151">        pendingOrder.setCurrentStep(PendingOrder.OrderStep.CONFIRM_ORDER);</span>

        // Show summary
<span class="nc" id="L154">        StringBuilder summary = new StringBuilder();</span>
<span class="nc" id="L155">        summary.append(&quot;üìã **X√°c nh·∫≠n th√¥ng tin ƒë∆°n h√†ng:**\n\n&quot;);</span>
<span class="nc" id="L156">        summary.append(&quot;üé´ S·ª± ki·ªán: &quot;).append(pendingOrder.getEvent().getTitle()).append(&quot;\n&quot;);</span>
<span class="nc" id="L157">        summary.append(&quot;üéüÔ∏è Lo·∫°i v√©: &quot;).append(pendingOrder.getTicketType().getName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L158">        summary.append(&quot;üí∞ Gi√°: &quot;).append(pendingOrder.getTicketType().getFinalPrice()).append(&quot; VND\n\n&quot;);</span>
<span class="nc" id="L159">        summary.append(&quot;üë§ Th√¥ng tin ng∆∞·ªùi tham gia:\n&quot;);</span>
<span class="nc" id="L160">        summary.append(&quot;- T√™n: &quot;).append(pendingOrder.getParticipantName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L161">        summary.append(&quot;- Email: &quot;).append(pendingOrder.getParticipantEmail()).append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (pendingOrder.getParticipantPhone() != null) {</span>
<span class="nc" id="L163">            summary.append(&quot;- SƒêT: &quot;).append(pendingOrder.getParticipantPhone()).append(&quot;\n&quot;);</span>
        }
<span class="nc" id="L165">        summary.append(&quot;\nüí° X√°c nh·∫≠n ƒë·∫∑t v√©? (C√≥/Kh√¥ng)&quot;);</span>

<span class="nc" id="L167">        return summary.toString();</span>
    }

    /**
     * Confirm and create order
     */
    @Transactional
    public Map&lt;String, Object&gt; confirmOrder(Long userId) {
<span class="fc" id="L175">        log.info(&quot;üîç DEBUG: Starting confirmOrder for userId: {}&quot;, userId);</span>

<span class="fc" id="L177">        PendingOrder pendingOrder = pendingOrders.get(userId);</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        log.info(&quot;üîç DEBUG: Found pending order: {}&quot;, pendingOrder != null ? &quot;YES&quot; : &quot;NO&quot;);</span>

<span class="fc" id="L180">        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</span>

<span class="pc bpc" id="L182" title="1 of 4 branches missed.">        if (pendingOrder == null || !pendingOrder.isComplete()) {</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">            log.error(&quot;‚ùå DEBUG: Pending order incomplete. pendingOrder={}, isComplete={}&quot;,</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">                    pendingOrder != null, pendingOrder != null ? pendingOrder.isComplete() : false);</span>
<span class="fc" id="L185">            result.put(&quot;success&quot;, false);</span>
<span class="fc" id="L186">            result.put(&quot;message&quot;, &quot;‚ùå Th√¥ng tin ƒë∆°n h√†ng kh√¥ng ƒë·∫ßy ƒë·ªß.&quot;);</span>
<span class="fc" id="L187">            return result;</span>
        }

<span class="fc" id="L190">        log.info(&quot;üîç DEBUG: Pending order details - Event: {}, TicketType: {}, Participant: {}&quot;,</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">                pendingOrder.getEvent() != null ? pendingOrder.getEvent().getTitle() : &quot;NULL&quot;,</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">                pendingOrder.getTicketType() != null ? pendingOrder.getTicketType().getName() : &quot;NULL&quot;,</span>
<span class="fc" id="L193">                pendingOrder.getParticipantName());</span>

        try {
            // Get customer
<span class="fc" id="L197">            log.info(&quot;üîç DEBUG: Looking for customer with userId: {}&quot;, userId);</span>
<span class="fc" id="L198">            Optional&lt;Customer&gt; customerOpt = userRepo.findByAccount_AccountId(userId);</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">            if (customerOpt.isEmpty()) {</span>
<span class="nc" id="L200">                log.error(&quot;‚ùå DEBUG: Customer not found for userId: {}&quot;, userId);</span>
<span class="nc" id="L201">                result.put(&quot;success&quot;, false);</span>
<span class="nc" id="L202">                result.put(&quot;message&quot;, &quot;‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng.&quot;);</span>
<span class="nc" id="L203">                return result;</span>
            }

<span class="fc" id="L206">            Customer customer = customerOpt.get();</span>
<span class="fc" id="L207">            log.info(&quot;üîç DEBUG: Customer found - customerId: {}, email: {}&quot;,</span>
<span class="fc" id="L208">                    customer.getCustomerId(), customer.getAccount().getEmail());</span>

            // Create order request
<span class="fc" id="L211">            CreateOrderWithTicketTypeRequest request = new CreateOrderWithTicketTypeRequest();</span>
<span class="fc" id="L212">            request.setEventId(pendingOrder.getEvent().getId());</span>
<span class="fc" id="L213">            request.setParticipantName(pendingOrder.getParticipantName());</span>
<span class="fc" id="L214">            request.setParticipantEmail(pendingOrder.getParticipantEmail());</span>
<span class="fc" id="L215">            request.setParticipantPhone(pendingOrder.getParticipantPhone());</span>
<span class="fc" id="L216">            request.setParticipantOrganization(pendingOrder.getParticipantOrganization());</span>
<span class="fc" id="L217">            request.setNotes(pendingOrder.getNotes());</span>
<span class="fc" id="L218">            request.setTicketTypeId(pendingOrder.getTicketType().getTicketTypeId());</span>

            // Create order
<span class="fc" id="L221">            log.info(&quot;üîç DEBUG: Creating order with OrderService...&quot;);</span>
<span class="fc" id="L222">            Order order = orderService.createOrderWithTicketTypes(request, customer);</span>
<span class="fc" id="L223">            log.info(&quot;üîç DEBUG: Order created successfully - orderId: {}, status: {}&quot;,</span>
<span class="fc" id="L224">                    order.getOrderId(), order.getStatus());</span>

            // Create payment link
<span class="fc" id="L227">            log.info(&quot;üîç DEBUG: Creating payment link...&quot;);</span>
<span class="fc" id="L228">            String returnUrl = &quot;http://localhost:8080/payment/success?orderId=&quot; + order.getOrderId();</span>
<span class="fc" id="L229">            String cancelUrl = &quot;http://localhost:8080/payment/cancel?orderId=&quot; + order.getOrderId();</span>
<span class="fc" id="L230">            Payment payment = paymentService.createPaymentLinkForOrder(order, returnUrl, cancelUrl);</span>
<span class="fc" id="L231">            log.info(&quot;üîç DEBUG: Payment created successfully - paymentId: {}, checkoutUrl: {}&quot;,</span>
<span class="fc" id="L232">                    payment.getPaymentId(), payment.getCheckoutUrl());</span>

            // Clear pending order
<span class="fc" id="L235">            pendingOrders.remove(userId);</span>
<span class="fc" id="L236">            log.info(&quot;üîç DEBUG: Pending order cleared for userId: {}&quot;, userId);</span>

            // Return success
<span class="fc" id="L239">            result.put(&quot;success&quot;, true);</span>
<span class="fc" id="L240">            result.put(&quot;orderId&quot;, order.getOrderId());</span>
<span class="fc" id="L241">            result.put(&quot;paymentUrl&quot;, payment.getCheckoutUrl());</span>
<span class="fc" id="L242">            result.put(&quot;qrCode&quot;, payment.getQrCode());</span>
<span class="fc" id="L243">            result.put(&quot;amount&quot;, payment.getAmount());</span>
<span class="fc" id="L244">            result.put(&quot;message&quot;, &quot;‚úÖ ƒê√£ t·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!\n&quot; +</span>
<span class="fc" id="L245">                    &quot;üîó Link thanh to√°n: &quot; + payment.getCheckoutUrl() + &quot;\n\n&quot; +</span>
                    &quot;üí° Vui l√≤ng thanh to√°n ƒë·ªÉ ho√†n t·∫•t ƒëƒÉng k√Ω.&quot;);

<span class="fc" id="L248">            log.info(&quot;‚úÖ DEBUG: Order creation completed successfully - orderId={}, userId={}, paymentId={}&quot;,</span>
<span class="fc" id="L249">                    order.getOrderId(), userId, payment.getPaymentId());</span>

            try {
<span class="fc" id="L252">                agentEventService.createOrUpdateEmailReminder(order.getEvent().getId(), 5, userId);</span>
<span class="fc" id="L253">                log.info(&quot;‚úÖ ƒê√£ t·∫°o l·ªãch nh·∫Øc nh·ªü m·∫∑c ƒë·ªãnh cho host khi t·∫°o event ID: {}&quot;, order.getEvent().getId());</span>
<span class="fc" id="L254">            } catch (Exception e) {</span>
<span class="fc" id="L255">                log.error(&quot;‚ùå L·ªói khi t·∫°o l·ªãch nh·∫Øc nh·ªü cho event ID: {} - {}&quot;,order.getEvent().getId(), e.getMessage(), e);</span>
                // Kh√¥ng throw exception ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn vi·ªác t·∫°o event
<span class="fc" id="L257">            }</span>

<span class="fc" id="L259">            return result;</span>


<span class="fc" id="L262">        } catch (Exception e) {</span>
<span class="fc" id="L263">            log.error(&quot;‚ùå DEBUG: Order creation failed with exception: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L264">            log.error(&quot;‚ùå DEBUG: Exception stack trace:&quot;, e);</span>
<span class="fc" id="L265">            result.put(&quot;success&quot;, false);</span>
<span class="fc" id="L266">            result.put(&quot;message&quot;, &quot;‚ùå L·ªói khi t·∫°o ƒë∆°n h√†ng: &quot; + e.getMessage());</span>
<span class="fc" id="L267">            return result;</span>
        }
    }

    /**
     * Cancel pending order
     */
    public String cancelOrder(Long userId) {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (pendingOrders.remove(userId) != null) {</span>
<span class="nc" id="L276">            return &quot;‚ùå ƒê√£ h·ªßy ƒë∆°n h√†ng.&quot;;</span>
        }
<span class="nc" id="L278">        return &quot;‚ÑπÔ∏è Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang ch·ªù x·ª≠ l√Ω.&quot;;</span>
    }

    /**
     * Get pending order status
     */
    public PendingOrder getPendingOrder(Long userId) {
<span class="nc" id="L285">        return pendingOrders.get(userId);</span>
    }

    /**
     * Check if user has pending order
     */
    public boolean hasPendingOrder(Long userId) {
<span class="nc" id="L292">        return pendingOrders.containsKey(userId);</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>