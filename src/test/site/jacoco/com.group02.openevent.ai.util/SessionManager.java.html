<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenEvent</a> &gt; <a href="index.source.html" class="el_package">com.group02.openevent.ai.util</a> &gt; <span class="el_source">SessionManager.java</span></div><h1>SessionManager.java</h1><pre class="source lang-java linenums">package com.group02.openevent.ai.util;

import com.group02.openevent.ai.service.EventAIAgent;
import com.group02.openevent.ai.exception.AIException;
import com.group02.openevent.ai.exception.AIErrorCodes;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Component
<span class="fc" id="L15">@Slf4j</span>
<span class="fc" id="L16">public class SessionManager {</span>

<span class="fc" id="L18">    private static final Map&lt;String, SessionInfo&gt; sessions = new ConcurrentHashMap&lt;&gt;();</span>
    private static EventAIAgent defaultAgent;
    
    // Session timeout: 30 minutes
    private static final long SESSION_TIMEOUT_MINUTES = 30;
    
    // Session info wrapper
    private static class SessionInfo {
        private final EventAIAgent agent;
        private final LocalDateTime createdAt;
        private LocalDateTime lastAccessed;
        
<span class="fc" id="L30">        public SessionInfo(EventAIAgent agent) {</span>
<span class="fc" id="L31">            this.agent = agent;</span>
<span class="fc" id="L32">            this.createdAt = LocalDateTime.now();</span>
<span class="fc" id="L33">            this.lastAccessed = LocalDateTime.now();</span>
<span class="fc" id="L34">        }</span>
        
<span class="nc" id="L36">        public EventAIAgent getAgent() { return agent; }</span>
<span class="nc" id="L37">        public LocalDateTime getCreatedAt() { return createdAt; }</span>
<span class="nc" id="L38">        public LocalDateTime getLastAccessed() { return lastAccessed; }</span>
        
        public void updateLastAccessed() {
<span class="nc" id="L41">            this.lastAccessed = LocalDateTime.now();</span>
<span class="nc" id="L42">        }</span>
        
        public boolean isExpired() {
<span class="nc" id="L45">            return lastAccessed.isBefore(LocalDateTime.now().minusMinutes(SESSION_TIMEOUT_MINUTES));</span>
        }
    }

    public static void setDefaultAgent(EventAIAgent agent) {
<span class="fc" id="L50">        defaultAgent = agent;</span>
<span class="fc" id="L51">        log.info(&quot;Default AI Agent set for SessionManager&quot;);</span>
<span class="fc" id="L52">    }</span>

    public static EventAIAgent get(String sessionId) throws AIException {
<span class="pc bpc" id="L55" title="2 of 4 branches missed.">        if (sessionId == null || sessionId.trim().isEmpty()) {</span>
<span class="nc" id="L56">            throw new AIException(AIErrorCodes.SESSION_INVALID, &quot;Session ID cannot be null or empty&quot;, </span>
                    &quot;❌ Session không hợp lệ&quot;);
        }
        
<span class="fc" id="L60">        SessionInfo sessionInfo = sessions.get(sessionId);</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        if (sessionInfo == null) {</span>
<span class="fc" id="L62">            throw new AIException(AIErrorCodes.SESSION_NOT_FOUND, &quot;Session not found: &quot; + sessionId, </span>
                    &quot;❌ Không tìm thấy session. Vui lòng tạo session mới.&quot;);
        }
        
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (sessionInfo.isExpired()) {</span>
<span class="nc" id="L67">            sessions.remove(sessionId);</span>
<span class="nc" id="L68">            throw new AIException(AIErrorCodes.SESSION_EXPIRED, &quot;Session expired: &quot; + sessionId, </span>
                    &quot;❌ Session đã hết hạn. Vui lòng tạo session mới.&quot;);
        }
        
<span class="nc" id="L72">        sessionInfo.updateLastAccessed();</span>
<span class="nc" id="L73">        return sessionInfo.getAgent();</span>
    }

    public static EventAIAgent getOrCreate(String sessionId) throws AIException {
        try {
<span class="nc" id="L78">            return get(sessionId);</span>
<span class="fc" id="L79">        } catch (AIException e) {</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">            if (AIErrorCodes.SESSION_NOT_FOUND.equals(e.getErrorCode())) {</span>
<span class="fc" id="L81">                return createSession(sessionId);</span>
            }
<span class="nc" id="L83">            throw e;</span>
        }
    }
    
    private static EventAIAgent createSession(String sessionId) throws AIException {
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (defaultAgent == null) {</span>
<span class="fc" id="L89">            throw new AIException(AIErrorCodes.SERVICE_UNAVAILABLE, &quot;Default AI Agent not initialized&quot;, </span>
                    &quot;❌ Hệ thống AI chưa sẵn sàng. Vui lòng thử lại sau.&quot;);
        }
        
<span class="fc" id="L93">        SessionInfo sessionInfo = new SessionInfo(defaultAgent);</span>
<span class="fc" id="L94">        sessions.put(sessionId, sessionInfo);</span>
<span class="fc" id="L95">        log.info(&quot;Created new AI session: {}&quot;, sessionId);</span>
<span class="fc" id="L96">        return defaultAgent;</span>
    }
    
    public static void put(String sessionId, EventAIAgent agent) {
<span class="nc bnc" id="L100" title="All 4 branches missed.">        if (sessionId != null &amp;&amp; agent != null) {</span>
<span class="nc" id="L101">            sessions.put(sessionId, new SessionInfo(agent));</span>
<span class="nc" id="L102">            log.info(&quot;Added AI session: {}&quot;, sessionId);</span>
        }
<span class="nc" id="L104">    }</span>
    
    public static void remove(String sessionId) {
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (sessionId != null) {</span>
<span class="fc" id="L108">            sessions.remove(sessionId);</span>
<span class="fc" id="L109">            log.info(&quot;Removed AI session: {}&quot;, sessionId);</span>
        }
<span class="fc" id="L111">    }</span>
    
    public static void clearAll() {
<span class="fc" id="L114">        int count = sessions.size();</span>
<span class="fc" id="L115">        sessions.clear();</span>
<span class="fc" id="L116">        log.info(&quot;Cleared all AI sessions. Removed {} sessions&quot;, count);</span>
<span class="fc" id="L117">    }</span>
    
    public static int getSessionCount() {
<span class="fc" id="L120">        return sessions.size();</span>
    }
    
    /**
     * Cleanup expired sessions every 10 minutes
     */
    @Scheduled(fixedRate = 600000) // 10 minutes
    public static void cleanupExpiredSessions() {
<span class="fc" id="L128">        int removedCount = 0;</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        for (Map.Entry&lt;String, SessionInfo&gt; entry : sessions.entrySet()) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (entry.getValue().isExpired()) {</span>
<span class="nc" id="L131">                sessions.remove(entry.getKey());</span>
<span class="nc" id="L132">                removedCount++;</span>
            }
<span class="nc" id="L134">        }</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if (removedCount &gt; 0) {</span>
<span class="nc" id="L136">            log.info(&quot;Cleaned up {} expired AI sessions&quot;, removedCount);</span>
        }
<span class="fc" id="L138">    }</span>
    
    /**
     * Get session statistics
     */
    public static Map&lt;String, Object&gt; getSessionStats() {
<span class="nc" id="L144">        return Map.of(</span>
<span class="nc" id="L145">            &quot;totalSessions&quot;, sessions.size(),</span>
<span class="nc" id="L146">            &quot;oldestSession&quot;, sessions.values().stream()</span>
<span class="nc" id="L147">                .map(SessionInfo::getCreatedAt)</span>
<span class="nc" id="L148">                .min(LocalDateTime::compareTo)</span>
<span class="nc" id="L149">                .orElse(null),</span>
<span class="nc" id="L150">            &quot;newestSession&quot;, sessions.values().stream()</span>
<span class="nc" id="L151">                .map(SessionInfo::getCreatedAt)</span>
<span class="nc" id="L152">                .max(LocalDateTime::compareTo)</span>
<span class="nc" id="L153">                .orElse(null)</span>
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>