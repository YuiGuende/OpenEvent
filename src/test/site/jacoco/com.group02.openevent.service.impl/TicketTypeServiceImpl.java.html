<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TicketTypeServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenEvent</a> &gt; <a href="index.source.html" class="el_package">com.group02.openevent.service.impl</a> &gt; <span class="el_source">TicketTypeServiceImpl.java</span></div><h1>TicketTypeServiceImpl.java</h1><pre class="source lang-java linenums">package com.group02.openevent.service.impl;

import com.group02.openevent.dto.request.TicketUpdateRequest;
import com.group02.openevent.dto.ticket.TicketTypeDTO;
import com.group02.openevent.mapper.TicketMapper;
import com.group02.openevent.model.event.Event;
import com.group02.openevent.model.ticket.TicketType;
import com.group02.openevent.repository.ITicketTypeRepo;
import com.group02.openevent.repository.IOrderRepo;
import com.group02.openevent.service.EventService;
import com.group02.openevent.service.TicketTypeService;
import jakarta.persistence.EntityNotFoundException;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

<span class="fc" id="L27">@Service</span>
@Transactional
<span class="fc" id="L29">public class TicketTypeServiceImpl implements TicketTypeService {</span>

    @Autowired
    private ITicketTypeRepo ticketTypeRepo;
    @Autowired
    private TicketMapper ticketMapper;
    @Autowired
    @Lazy
    private EventService eventService;
    @Autowired
    private IOrderRepo orderRepo;


    @Override
    public Optional&lt;TicketType&gt; getTicketTypeById(Long id) {
<span class="fc" id="L44">        return ticketTypeRepo.findById(id);</span>
    }

    @Override
    public List&lt;TicketType&gt; getAllTicketTypes() {
<span class="fc" id="L49">        return ticketTypeRepo.findAll();</span>
    }

    @Override
    public void updateTickets(Long eventId, List&lt;TicketUpdateRequest&gt; tickets) {
<span class="fc bfc" id="L54" title="All 2 branches covered.">        for (TicketUpdateRequest request : tickets) {</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">            if (Boolean.TRUE.equals(request.getIsDeleted())) {</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">                if (request.getTicketTypeId() != null) {</span>
<span class="fc" id="L57">                    ticketTypeRepo.deleteById(request.getTicketTypeId());</span>
                }
                continue;
            }

<span class="fc" id="L62">            TicketType ticket = ticketMapper.toTicketType(request);</span>

<span class="fc bfc" id="L64" title="All 2 branches covered.">            if (Boolean.TRUE.equals(request.getIsNew())) {</span>
<span class="fc" id="L65">                Event event = eventService.getEventById(eventId)</span>
<span class="pc" id="L66">                        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Event not found&quot;));</span>
<span class="fc" id="L67">                ticket.setEvent(event);</span>
                // Ensure INSERT for new tickets (avoid trying to UPDATE a non-existent row)
<span class="fc" id="L69">                ticket.setTicketTypeId(null);</span>
<span class="fc" id="L70">            } else {</span>
<span class="fc" id="L71">                TicketType existing = ticketTypeRepo.findById(request.getTicketTypeId())</span>
<span class="pc" id="L72">                        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Ticket not found&quot;));</span>
                // Do not override identifier or relations
<span class="fc" id="L74">                BeanUtils.copyProperties(ticket, existing, &quot;ticketTypeId&quot;, &quot;event&quot;);</span>
<span class="fc" id="L75">                ticket = existing;</span>
            }

<span class="fc" id="L78">            ticketTypeRepo.save(ticket);</span>
<span class="fc" id="L79">        }</span>
<span class="fc" id="L80">    }</span>

    @Override
    public void deleteTicketType(Long id) {
<span class="fc" id="L84">        TicketType ticketType = ticketTypeRepo.findById(id)</span>
<span class="fc" id="L85">                .orElse(null);</span>
        // Kiểm tra đã bán vé chưa
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        assert ticketType != null;</span>

        // Nếu có đơn hàng tham chiếu đến ticket type này thì không cho xóa
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (orderRepo.existsByTicketType_TicketTypeId(id)) {</span>
<span class="fc" id="L91">            throw new IllegalStateException(&quot;Không thể xóa loại vé vì đã có đơn hàng liên quan&quot;);</span>
        }

        // Dự phòng: nếu soldQuantity &gt; 0 cũng không cho xóa
<span class="pc bpc" id="L95" title="2 of 4 branches missed.">        if (ticketType.getSoldQuantity() != null &amp;&amp; ticketType.getSoldQuantity() &gt; 0) {</span>
<span class="nc" id="L96">            throw new IllegalStateException(&quot;Không thể xóa loại vé đã bán&quot;);</span>
        }

<span class="fc" id="L99">        ticketTypeRepo.delete(ticketType);</span>
<span class="fc" id="L100">    }</span>

    @Override
    public List&lt;TicketType&gt; getTicketTypesByEventId(Long eventId) {
<span class="nc" id="L104">        return ticketTypeRepo.findByEventId(eventId);</span>
    }

    @Override
    public List&lt;TicketType&gt; getAvailableTicketTypesByEventId(Long eventId) {
<span class="nc" id="L109">        return ticketTypeRepo.findAvailableByEventId(eventId, LocalDateTime.now());</span>
    }

    @Override
    public boolean canPurchaseTickets(Long ticketTypeId, Integer quantity) {
<span class="fc" id="L114">        Optional&lt;TicketType&gt; ticketTypeOpt = ticketTypeRepo.findById(ticketTypeId);</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (ticketTypeOpt.isEmpty()) {</span>
<span class="fc" id="L116">            return false;</span>
        }
<span class="fc" id="L118">        return ticketTypeOpt.get().canPurchase();</span>
    }

    @Override
    @Transactional
    public void reserveTickets(Long ticketTypeId) {
<span class="fc" id="L124">        TicketType ticketType = ticketTypeRepo.findById(ticketTypeId)</span>
<span class="fc" id="L125">                .orElse(null);</span>

<span class="pc bpc" id="L127" title="1 of 2 branches missed.">        assert ticketType != null;</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (!ticketType.canPurchase()) {</span>
<span class="fc" id="L129">            throw new IllegalStateException(&quot;Cannot reserve tickets for ticket type: &quot; + ticketTypeId);</span>
        }

<span class="fc" id="L132">        ticketType.increaseSoldQuantity();</span>
<span class="fc" id="L133">        ticketTypeRepo.save(ticketType);</span>
<span class="fc" id="L134">    }</span>

    @Override
    @Transactional
    public void releaseTickets(Long ticketTypeId, Integer quantity) {
<span class="fc" id="L139">        TicketType ticketType = ticketTypeRepo.findById(ticketTypeId)</span>
<span class="fc" id="L140">                .orElse(null);</span>

<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        assert ticketType != null;</span>
<span class="fc" id="L143">        ticketType.decreaseSoldQuantity(quantity);</span>
<span class="fc" id="L144">        ticketTypeRepo.save(ticketType);</span>
<span class="fc" id="L145">    }</span>

    @Override
    @Transactional
    public void confirmPurchase(Long ticketTypeId, Integer quantity) {
        // Trong trường hợp này, việc reserve đã tăng soldQuantity
        // Nên confirmPurchase chỉ cần log hoặc update trạng thái khác
<span class="nc" id="L152">        TicketType ticketType = ticketTypeRepo.findById(ticketTypeId)</span>
<span class="nc" id="L153">                .orElse(null);</span>

        // Purchase confirmed
<span class="nc" id="L156">    }</span>

    @Override
    public Page&lt;TicketType&gt; getTicketTypesPageable(Pageable pageable) {
<span class="fc" id="L160">        return ticketTypeRepo.findAll(pageable);</span>
    }

    @Override
    public List&lt;TicketType&gt; getTicketTypesByPriceRange(BigDecimal minPrice, BigDecimal maxPrice) {
<span class="nc" id="L165">        return ticketTypeRepo.findByPriceRange(minPrice, maxPrice);</span>
    }

    @Override
    public boolean isTicketTypeAvailable(Long ticketTypeId) {
<span class="nc" id="L170">        return ticketTypeRepo.isAvailableNow(ticketTypeId, LocalDateTime.now());</span>
    }

    @Override
    public Integer getTotalSoldByEventId(Long eventId) {
<span class="fc" id="L175">        Integer result = ticketTypeRepo.getTotalSoldByEventId(eventId);</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">        return result != null ? result : 0;</span>
    }

    @Override
    public Integer getTotalAvailableByEventId(Long eventId) {
<span class="nc" id="L181">        Integer result = ticketTypeRepo.getTotalAvailableByEventId(eventId);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        return result != null ? result : 0;</span>
    }

    @Override
    @Transactional(readOnly = true)
    public List&lt;TicketTypeDTO&gt; getTicketTypeDTOsByEventId(Long eventId) {
<span class="fc" id="L188">        List&lt;TicketType&gt; ticketTypeList = ticketTypeRepo.findByEventId(eventId);</span>
<span class="fc" id="L189">        return ticketTypeRepo.findByEventId(eventId)</span>
<span class="fc" id="L190">                .stream()</span>
<span class="fc" id="L191">                .map(this::convertToDTO)</span>
<span class="fc" id="L192">                .collect(Collectors.toList());</span>
    }

    @Override
    @Transactional(readOnly = true)
    public List&lt;TicketTypeDTO&gt; getAvailableTicketTypeDTOsByEventId(Long eventId) {
<span class="fc" id="L198">        return ticketTypeRepo.findAvailableByEventIdIgnoreTime(eventId)</span>
<span class="fc" id="L199">                .stream()</span>
<span class="fc" id="L200">                .map(this::convertToDTO)</span>
<span class="fc" id="L201">                .collect(Collectors.toList());</span>
    }

    @Override
    @Transactional(readOnly = true)
    public Optional&lt;TicketTypeDTO&gt; getTicketTypeDTOById(Long ticketTypeId) {
<span class="nc" id="L207">        return ticketTypeRepo.findById(ticketTypeId)</span>
<span class="nc" id="L208">                .map(this::convertToDTO);</span>
    }

    @Override
    @Transactional
    public TicketType saveTicketType(TicketType ticketType) {
<span class="fc" id="L214">        return ticketTypeRepo.save(ticketType);</span>
    }

//    @Override
//    @Transactional
//    public void deleteTicketType(Long ticketTypeId) {
//        ticketTypeRepo.deleteById(ticketTypeId);
//    }

    @Override
    public TicketTypeDTO convertToDTO(TicketType ticketType) {
        try {
<span class="fc" id="L226">            LocalDateTime now = LocalDateTime.now();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">            boolean isAvailable = ticketType.getAvailableQuantity() &gt; 0</span>
<span class="pc bpc" id="L228" title="1 of 4 branches missed.">                    &amp;&amp; (ticketType.getStartSaleDate() == null || now.isAfter(ticketType.getStartSaleDate()))</span>
<span class="pc bpc" id="L229" title="1 of 4 branches missed.">                    &amp;&amp; (ticketType.getEndSaleDate() == null || now.isBefore(ticketType.getEndSaleDate()));</span>

<span class="fc" id="L231">            boolean isSaleActive = ticketType.isSalePeriodActive();</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">            boolean isSoldOut = ticketType.getAvailableQuantity() &lt;= 0;</span>
<span class="pc bpc" id="L233" title="1 of 4 branches missed.">            boolean saleNotStarted = ticketType.getStartSaleDate() != null &amp;&amp; now.isBefore(ticketType.getStartSaleDate());</span>
<span class="pc bpc" id="L234" title="1 of 4 branches missed.">            boolean saleOverdue = ticketType.getEndSaleDate() != null &amp;&amp; now.isAfter(ticketType.getEndSaleDate());</span>

<span class="fc" id="L236">            String saleStartCountdownText = null;</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">            if (saleNotStarted) {</span>
<span class="fc" id="L238">                LocalDateTime start = ticketType.getStartSaleDate();</span>
<span class="fc" id="L239">                long days = java.time.Duration.between(now, start).toDays();</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                if (days &lt; 0) days = 0;</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">                saleStartCountdownText = days + (days == 1 ? &quot; day&quot; : &quot; days&quot;);</span>
            }

<span class="fc" id="L244">            TicketTypeDTO ticketTypeDTO = TicketTypeDTO.builder()</span>
<span class="fc" id="L245">                    .ticketTypeId(ticketType.getTicketTypeId())</span>
<span class="fc" id="L246">                    .eventId(ticketType.getEvent().getId())</span>
<span class="fc" id="L247">                    .eventTitle(ticketType.getEvent().getTitle())</span>
<span class="fc" id="L248">                    .eventImageUrl(ticketType.getEvent().getImageUrl())</span>
<span class="fc" id="L249">                    .name(ticketType.getName())</span>
<span class="fc" id="L250">                    .description(ticketType.getDescription())</span>
<span class="fc" id="L251">                    .price(ticketType.getPrice())</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">                    .sale(ticketType.getSale() != null ? ticketType.getSale() : BigDecimal.ZERO)</span>
<span class="fc" id="L253">                    .finalPrice(ticketType.getFinalPrice())</span>
<span class="fc" id="L254">                    .totalQuantity(ticketType.getTotalQuantity())</span>
<span class="fc" id="L255">                    .soldQuantity(ticketType.getSoldQuantity())</span>
<span class="fc" id="L256">                    .availableQuantity(ticketType.getAvailableQuantity())</span>
<span class="fc" id="L257">                    .startSaleDate(ticketType.getStartSaleDate())</span>
<span class="fc" id="L258">                    .endSaleDate(ticketType.getEndSaleDate())</span>
<span class="fc" id="L259">                    .isAvailable(isAvailable)</span>
<span class="fc" id="L260">                    .isSaleActive(isSaleActive)</span>
<span class="fc" id="L261">                    .isSoldOut(isSoldOut)</span>
<span class="fc" id="L262">                    .saleNotStarted(saleNotStarted)</span>
<span class="fc" id="L263">                    .saleStartCountdownText(saleStartCountdownText)</span>
<span class="fc" id="L264">                    .saleOverdue(saleOverdue)</span>
<span class="fc" id="L265">                    .build();</span>
<span class="fc" id="L266">            return ticketTypeDTO;</span>
<span class="fc" id="L267">        } catch (Exception e) {</span>
<span class="fc" id="L268">            System.err.println(&quot;Error converting TicketType to DTO: &quot; + e.getMessage());</span>
<span class="fc" id="L269">            e.printStackTrace();</span>
<span class="fc" id="L270">            throw e;</span>
        }
    }

    @Override
    @Transactional(readOnly = true)
    public Integer getTotalSoldTickets(Long eventId) {
<span class="nc" id="L277">        Integer total = ticketTypeRepo.getTotalSoldByEventId(eventId);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        return total != null ? total : 0;</span>
    }

    @Override
    @Transactional(readOnly = true)
    public Integer getTotalTicketCapacity(Long eventId) {
<span class="nc" id="L284">        Integer total = ticketTypeRepo.getTotalTicketCapacityByEventId(eventId);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        return total != null ? total : 0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>